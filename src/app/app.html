<div class="app-shell">
  <header class="topbar" *ngIf="!isAuthPage()">

    <div class="topbar-container">
      <div class="topbar-left">
        <a routerLink="/home" class="brand">
          <img
            src="http://localhost:8080/uploads/products/logo.jpg"
            alt="Enoch Leathercraft Logo"
            class="brand-logo"
          />
          <span class="brand-title">ENOCH LEATHERCRAFT</span>
        </a>

        <nav class="main-nav">
          <a routerLink="/home" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">{{ 'nav.home' | t }}</a>
          <a routerLink="/products" [queryParams]="{ sort: 'newest' }" routerLinkActive="active">{{ 'nav.new' | t }}</a>
          <a routerLink="/products" [queryParams]="{ segment: 'homme' }" routerLinkActive="active">{{ 'nav.men' | t }}</a>
          <a routerLink="/products" [queryParams]="{ segment: 'femme' }" routerLinkActive="active">{{ 'nav.women' | t }}</a>
          <a routerLink="/products" [queryParams]="{ segment: 'petite-maroquinerie' }" routerLinkActive="active">{{ 'nav.smallLeather' | t }}</a>
          <a routerLink="/about" routerLinkActive="active">{{ 'nav.about' | t }}</a>
          <a routerLink="/contact" routerLinkActive="active">{{ 'nav.contact' | t }}</a>
        </nav>
      </div>

      <div class="topbar-right">

        <div class="lang-switcher">
          <button type="button" class="lang-opt" [class.active]="currentLang === 'fr'" (click)="changeLang('fr')">FR</button>
          <span class="sep">|</span>
          <button type="button" class="lang-opt" [class.active]="currentLang === 'en'" (click)="changeLang('en')">EN</button>
        </div>

        <button class="icon-btn" (click)="goToWishlist()" title="Favoris">
          <span class="icon">â™¥</span>
          <span class="badge" *ngIf="wishlistCount > 0">{{ wishlistCount }}</span>
        </button>

        <div class="cart-wrapper" (mouseenter)="miniCartOpen = true" (mouseleave)="miniCartOpen = false">
          <button class="icon-btn cart-btn" (click)="goToCart()">
            <span class="icon">ðŸ›’</span> <span class="badge cart-badge" *ngIf="cartQuantity > 0">{{ cartQuantity }}</span>
          </button>

          <div class="cart-popover" *ngIf="miniCartOpen && (cart$ | async) as cart">
            <div class="popover-header">
              <h3>{{ 'cart.title' | t }}</h3>
              <span class="qty-total">{{ cart.totalQuantity }} art.</span>
            </div>

            <div class="mini-timer" *ngIf="cart.items.length > 0">
              <ng-container *ngIf="(timeLeftMs$ | async) as ms">
                <span *ngIf="ms > 0">Temps restant : <strong>{{ formatMs(ms) }}</strong></span>
                <span class="danger" *ngIf="ms === 0">ExpirÃ©</span>
              </ng-container>
            </div>

            <div class="cart-items-list" *ngIf="cart.items.length > 0; else emptyCart">
              <div class="cart-item" *ngFor="let item of cart.items">
                <img [src]="cartService.getCartItemImage(item)" class="item-thumb" (error)="onImgError($event)">
                <div class="item-info">
                  <span class="item-name">{{ item.name }}</span>
                  <span class="item-meta">{{ item.quantity }} x {{ item.unitPrice | currency:'EUR' }}</span>
                </div>
                <span class="item-price">{{ item.lineTotal | currency:'EUR' }}</span>
              </div>
            </div>

            <div class="popover-footer" *ngIf="cart.items.length > 0">
              <div class="subtotal">
                <span>Total</span>
                <span>{{ cart.totalAmount | currency:'EUR' }}</span>
              </div>
              <button class="btn-view-cart" (click)="goToCart()">{{ 'cart.view' | t }}</button>
            </div>

            <ng-template #emptyCart>
              <div class="empty-state">{{ 'cart.empty' | t }}</div>
            </ng-template>
          </div>
        </div>

        <div class="auth-actions" *ngIf="isLoggedIn; else guest">
          <a routerLink="/profile" class="auth-link">Mon Compte</a>
          <button class="auth-link logout" (click)="logout()">DÃ©connexion</button>
        </div>

        <ng-template #guest>
          <a routerLink="/login" class="auth-link">Connexion</a>
        </ng-template>

        <button class="burger" (click)="mobileNavOpen = !mobileNavOpen">
          <span></span><span></span><span></span>
        </button>
      </div>
    </div>

    <div class="mobile-nav" [class.open]="mobileNavOpen">
      <a routerLink="/home" (click)="mobileNavOpen=false">{{ 'nav.home' | t }}</a>
      <a routerLink="/products" (click)="mobileNavOpen=false">{{ 'nav.new' | t }}</a>
      <a routerLink="/products" [queryParams]="{ segment: 'homme' }" (click)="mobileNavOpen=false">{{ 'nav.men' | t }}</a>
      <a routerLink="/products" [queryParams]="{ segment: 'femme' }" (click)="mobileNavOpen=false">{{ 'nav.women' | t }}</a>
      <a routerLink="/products" [queryParams]="{ segment: 'petite-maroquinerie' }" (click)="mobileNavOpen=false">{{ 'nav.smallLeather' | t }}</a>
      <a routerLink="/about" (click)="mobileNavOpen=false">{{ 'nav.about' | t }}</a>
      <a routerLink="/contact" (click)="mobileNavOpen=false">{{ 'nav.contact' | t }}</a>
    </div>
  </header>

  <div class="auth-warning" *ngIf="authWarning">{{ authWarning }}</div>

  <main class="page">
    <router-outlet></router-outlet>
  </main>

  <app-cookie-banner></app-cookie-banner>
</div>
