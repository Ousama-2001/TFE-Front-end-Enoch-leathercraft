<div class="account">

  <div class="account-header">
    <div>
      <h1>{{ 'account.title' | t }}</h1>
      <p class="subtitle">
        {{ 'account.subtitle' | t }}
      </p>
    </div>
  </div>

  <div class="tabs">
    <button [class.active]="activeTab === 'overview'" (click)="switchTab('overview')">
      {{ 'account.tabs.overview' | t }}
    </button>
    <button [class.active]="activeTab === 'profile'" (click)="switchTab('profile')">
      {{ 'account.tabs.profile' | t }}
    </button>
    <button [class.active]="activeTab === 'address'" (click)="switchTab('address')">
      {{ 'account.tabs.address' | t }}
    </button>
    <button [class.active]="activeTab === 'orders'" (click)="switchTab('orders')">
      {{ 'account.tabs.orders' | t }}
    </button>
    <button [class.active]="activeTab === 'security'" (click)="switchTab('security')">
      {{ 'account.tabs.security' | t }}
    </button>
  </div>

  <p *ngIf="error" class="alert error">{{ error }}</p>
  <p *ngIf="success" class="alert success">{{ success }}</p>

  <section *ngIf="activeTab === 'overview'" class="section">
    <div class="overview-grid">
      <div class="card profile-card">
        <div class="avatar">
          {{ (profile.firstName || profile.lastName || profile.email || 'U').charAt(0) | uppercase }}
        </div>
        <div class="profile-info">
          <h2>{{ profile.firstName }} {{ profile.lastName }}</h2>
          <p class="email">{{ profile.email }}</p>

          <p class="location" *ngIf="profile.city || profile.country">
            {{ profile.city }}<span *ngIf="profile.city && profile.country"> · </span>{{ profile.country }}
          </p>

          <p class="muted" *ngIf="!profile.city && !profile.country">
            {{ 'account.overview.completeProfileHint' | t }}
          </p>
        </div>
      </div>

      <div class="card stat-card">
        <span class="stat-label">{{ 'account.overview.totalOrders' | t }}</span>
        <span class="stat-value">{{ myOrders.length }}</span>
        <span class="stat-hint">{{ 'account.overview.sinceAccountCreation' | t }}</span>
      </div>

      <div class="card stat-card">
        <span class="stat-label">{{ 'account.overview.totalSpent' | t }}</span>
        <span class="stat-value">{{ totalSpent | currency:'EUR' }}</span>
        <span class="stat-hint">{{ 'account.overview.totalAmountHint' | t }}</span>
      </div>

      <div class="card last-order-card" *ngIf="myOrders.length; else noOrder">
        <span class="stat-label">{{ 'account.overview.lastOrder' | t }}</span>
        <div class="last-order-main">
          <div>
            <div class="ref">{{ 'account.orders.ref' | t }} : {{ myOrders[0].reference }}</div>
            <div class="meta">
              {{ myOrders[0].createdAt | date:'dd/MM/yy HH:mm' }} · {{ myOrders[0].status }}
            </div>
          </div>
        </div>
      </div>

      <ng-template #noOrder>
        <div class="card last-order-card">
          <span class="stat-label">{{ 'account.overview.lastOrder' | t }}</span>
          <p class="muted">{{ 'account.orders.empty' | t }}</p>
        </div>
      </ng-template>
    </div>
  </section>

  <section *ngIf="activeTab === 'profile'" class="section">
    <div class="card">
      <h2>{{ 'account.profile.title' | t }}</h2>
      <form (ngSubmit)="saveProfile()">
        <div class="grid">
          <label>
            {{ 'account.profile.firstName' | t }}
            <input [(ngModel)]="profile.firstName" name="fn">
          </label>
          <label>
            {{ 'account.profile.lastName' | t }}
            <input [(ngModel)]="profile.lastName" name="ln">
          </label>
          <label>
            {{ 'account.profile.email' | t }}
            <input [value]="profile.email" disabled>
          </label>
          <label>
            {{ 'account.profile.phone' | t }}
            <input [(ngModel)]="profile.phone" name="ph">
          </label>
        </div>
        <button class="btn primary" [disabled]="savingProfile">
          {{ savingProfile ? ('account.profile.saving' | t) : ('account.profile.save' | t) }}
        </button>
      </form>
    </div>
  </section>

  <section *ngIf="activeTab === 'address'" class="section">
    <div class="card">
      <h2>{{ 'account.address.title' | t }}</h2>
      <form (ngSubmit)="saveProfile()">
        <div class="grid">
          <label>
            {{ 'account.address.address' | t }}
            <input [(ngModel)]="profile.addressLine1" name="ad">
          </label>
          <label>
            {{ 'account.address.postalCode' | t }}
            <input [(ngModel)]="profile.postalCode" name="pc">
          </label>
          <label>
            {{ 'account.address.city' | t }}
            <input [(ngModel)]="profile.city" name="ct">
          </label>
          <label>
            {{ 'account.address.country' | t }}
            <input [(ngModel)]="profile.country" name="co">
          </label>
        </div>
        <button class="btn primary" [disabled]="savingProfile">
          {{ savingProfile ? ('account.address.saving' | t) : ('account.address.save' | t) }}
        </button>
      </form>
    </div>
  </section>

  <section *ngIf="activeTab === 'orders'" class="section">
    <div class="card">
      <h2>{{ 'account.orders.title' | t }}</h2>
      <p *ngIf="loadingOrders">{{ 'account.orders.loading' | t }}</p>
      <p *ngIf="!loadingOrders && !myOrders.length" class="muted">
        {{ 'account.orders.empty' | t }}
      </p>
      <ul *ngIf="!loadingOrders && myOrders.length" class="mini-orders-list">
        <li *ngFor="let o of myOrders | slice:0:3">
          <div class="mini-order-main">
            <div class="ref">{{ 'account.orders.ref' | t }} : {{ o.reference }}</div>
            <div class="meta">
              {{ o.createdAt | date:'dd/MM/yy HH:mm' }} ·
              {{ o.totalAmount | currency:'EUR' }}
            </div>
          </div>
          <span class="mini-status">
              {{ getOrderStatusLabel(o.status) }}
          </span>
        </li>
      </ul>
      <div class="orders-link-wrapper" *ngIf="myOrders.length">
        <a routerLink="/my-orders" class="btn primary">
          {{ 'account.orders.seeAll' | t }} →
        </a>
      </div>
    </div>
  </section>

  <section *ngIf="activeTab === 'security'" class="section security-section">
    <div class="card">
      <h2>{{ 'account.security.title' | t }}</h2>
      <form (ngSubmit)="submitPasswordChange()">
        <label>
          {{ 'account.security.oldPassword' | t }}
          <input type="password" [(ngModel)]="oldPassword" name="old">
        </label>
        <label>
          {{ 'account.security.newPassword' | t }}
          <input type="password" [(ngModel)]="newPassword" name="new">
        </label>
        <label>
          {{ 'account.security.confirm' | t }}
          <input type="password" [(ngModel)]="confirmPassword" name="cnf">
        </label>
        <button class="btn primary" [disabled]="changingPassword">
          {{ changingPassword ? ('account.security.changing' | t) : ('account.security.change' | t) }}
        </button>
      </form>
    </div>

    <div class="card">
      <h2>{{ 'account.security.changeEmail.title' | t }}</h2>
      <p class="muted">
        {{ 'account.security.changeEmail.hint' | t }}
      </p>

      <form (ngSubmit)="submitEmailChangeRequest()">
        <label>
          {{ 'account.security.changeEmail.newEmail' | t }}
          <input type="email" [(ngModel)]="newEmail" name="newEmail" placeholder="nouvel@email.com">
        </label>

        <label>
          {{ 'account.security.changeEmail.currentPassword' | t }}
          <input type="password" [(ngModel)]="emailCurrentPassword" name="emailPwd" placeholder="••••••••">
        </label>

        <button class="btn primary" [disabled]="requestingEmailChange">
          {{ requestingEmailChange ? ('account.security.changing' | t) : ('account.security.changeEmail.submit' | t) }}
        </button>

        <p *ngIf="emailChangeInfo" class="alert success">{{ emailChangeInfo }}</p>
      </form>
    </div>

    <div class="card danger-card">
      <h2>{{ 'account.security.dangerZone' | t }}</h2>
      <p class="muted">{{ 'account.security.deleteHint' | t }}</p>
      <button class="btn danger" (click)="deleteAccount()">
        {{ 'account.security.deleteAccount' | t }}
      </button>
    </div>
  </section>
</div>
