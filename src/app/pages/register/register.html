<div class="auth-page">
  <div class="auth-card">
    <h1>Créer un compte</h1>
    <p class="subtitle">Rejoins Enoch Leathercraft Shop</p>

    <form #f="ngForm" (ngSubmit)="onSubmit(f)" novalidate>
      <div class="form-row two-cols">
        <div class="form-group">
          <label>Prénom</label>
          <input
            type="text"
            [(ngModel)]="firstName"
            name="firstName"
            required
            minlength="2"
            #firstNameCtrl="ngModel"
            [class.invalid]="submitted && firstNameCtrl.invalid"
          />
          <p class="field-error" *ngIf="submitted && firstNameCtrl.invalid">
            Prénom requis (min 2 caractères).
          </p>
        </div>

        <div class="form-group">
          <label>Nom</label>
          <input
            type="text"
            [(ngModel)]="lastName"
            name="lastName"
            required
            minlength="2"
            #lastNameCtrl="ngModel"
            [class.invalid]="submitted && lastNameCtrl.invalid"
          />
          <p class="field-error" *ngIf="submitted && lastNameCtrl.invalid">
            Nom requis (min 2 caractères).
          </p>
        </div>
      </div>

      <div class="form-group">
        <label>Pseudo</label>

        <div class="input-with-status">
          <input
            type="text"
            [ngModel]="username"
            (ngModelChange)="onUsernameInput($event)"
            name="username"
            required
            minlength="3"
            maxlength="20"
            pattern="^[a-zA-Z0-9._-]{3,20}$"
            #usernameCtrl="ngModel"
            [class.invalid]="submitted && usernameCtrl.invalid"
          />

          <span
            class="status"
            [class.ok]="usernameAvailability === 'available'"
            [class.bad]="usernameAvailability === 'taken'"
            [class.wait]="usernameAvailability === 'checking'"
          >
            <ng-container [ngSwitch]="usernameAvailability">
              <span *ngSwitchCase="'checking'">⏳</span>
              <span *ngSwitchCase="'available'">✅</span>
              <span *ngSwitchCase="'taken'">❌</span>
              <span *ngSwitchDefault></span>
            </ng-container>
          </span>
        </div>

        <p class="hint">3–20 caractères : lettres, chiffres, . _ -</p>

        <p class="field-error" *ngIf="submitted && usernameCtrl.invalid">
          Pseudo invalide.
        </p>
        <p class="field-error" *ngIf="usernameAvailability === 'taken'">
          Ce pseudo est déjà utilisé.
        </p>
      </div>

      <div class="form-group">
        <label>Email</label>

        <div class="input-with-status">
          <input
            type="email"
            [ngModel]="email"
            (ngModelChange)="onEmailInput($event)"
            name="email"
            required
            pattern="^[^\s@]+@[^\s@]+\.[^\s@]{2,}$"
            #emailCtrl="ngModel"
            [class.invalid]="submitted && emailCtrl.invalid"
          />

          <span
            class="status"
            [class.ok]="emailAvailability === 'available'"
            [class.bad]="emailAvailability === 'taken'"
            [class.wait]="emailAvailability === 'checking'"
          >
            <ng-container [ngSwitch]="emailAvailability">
              <span *ngSwitchCase="'checking'">⏳</span>
              <span *ngSwitchCase="'available'">✅</span>
              <span *ngSwitchCase="'taken'">❌</span>
              <span *ngSwitchDefault></span>
            </ng-container>
          </span>
        </div>

        <p class="field-error" *ngIf="submitted && emailCtrl.invalid">
          Email invalide.
        </p>
        <p class="field-error" *ngIf="emailAvailability === 'taken'">
          Cet email est déjà utilisé.
        </p>
      </div>

      <div class="form-group">
        <label>Mot de passe</label>
        <input
          type="password"
          [(ngModel)]="password"
          name="password"
          required
          minlength="8"
          [pattern]="strongPasswordRegex.source"
          #passwordCtrl="ngModel"
          [class.invalid]="submitted && passwordCtrl.invalid"
        />
        <p class="hint">
          8+ caractères, 1 maj, 1 min, 1 chiffre, 1 spécial, pas d’espace.
        </p>
        <p class="field-error" *ngIf="submitted && passwordCtrl.invalid">
          Mot de passe trop faible.
        </p>
      </div>

      <div class="terms-row">
        <label class="terms-checkbox">
          <input type="checkbox" [(ngModel)]="acceptTerms" name="acceptTerms" required />
          <span>
            J’accepte les
            <a routerLink="/terms" target="_blank" rel="noopener noreferrer">
              Conditions Générales
            </a>
          </span>
        </label>

        <p class="terms-error" *ngIf="submitted && !acceptTerms">
          Tu dois accepter les Conditions Générales pour créer ton compte.
        </p>
      </div>

      <button
        type="submit"
        [disabled]="
          !acceptTerms ||
          f.invalid ||
          usernameAvailability === 'checking' ||
          emailAvailability === 'checking' ||
          usernameAvailability === 'taken' ||
          emailAvailability === 'taken'
        "
      >
        S'inscrire
      </button>

      <p class="error" *ngIf="error">{{ error }}</p>

      <p class="switch-link">
        Déjà un compte ?
        <a
          routerLink="/login"
          [queryParams]="returnUrl ? { returnUrl: returnUrl } : null"
        >
          Se connecter
        </a>
      </p>
    </form>
  </div>
</div>
