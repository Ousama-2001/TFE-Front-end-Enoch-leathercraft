<!-- src/app/pages/admin/admin-dashboard.html -->
<div class="admin-dashboard">

  <!-- HEADER + ONGLET -->
  <div class="admin-header">
    <h1>Tableau de bord administrateur</h1>
    <p class="subtitle">
      Gestion des ventes, des produits, du stock et des utilisateurs pour Enoch Leathercraft.
    </p>

    <div class="admin-tabs">
      <button class="tab-btn"
              [class.active]="activeTab === 'stats'"
              (click)="setTab('stats')">
        Statistiques de vente
      </button>

      <button class="tab-btn"
              [class.active]="activeTab === 'orders'"
              (click)="setTab('orders')">
        Commandes
      </button>

      <!-- Onglet retours -->
      <button class="tab-btn"
              [class.active]="activeTab === 'returns'"
              (click)="setTab('returns')">
        Retours
      </button>

      <button class="tab-btn"
              [class.active]="activeTab === 'products'"
              (click)="setTab('products')">
        Gestion des produits
      </button>

      <button class="tab-btn"
              [class.active]="activeTab === 'stock'"
              (click)="setTab('stock')">
        Gestion du stock
      </button>

      <button class="tab-btn"
              [class.active]="activeTab === 'reviews'"
              (click)="setTab('reviews')">
        Gestion des avis
      </button>

      <!-- ‚úÖ Support (ADMIN + SUPER_ADMIN) -->
      <button class="tab-btn"
              *ngIf="isAdminOrSuperAdmin"
              [class.active]="activeTab === 'support'"
              (click)="setTab('support')">
        Support (messages)
      </button>

      <!-- üîê Onglets r√©serv√©s au SUPER ADMIN -->
      <button class="tab-btn"
              *ngIf="isSuperAdmin"
              [class.active]="activeTab === 'users'"
              (click)="setTab('users')">
        Gestion des utilisateurs
      </button>

      <button class="tab-btn"
              *ngIf="isSuperAdmin"
              [class.active]="activeTab === 'requests'"
              (click)="setTab('requests')">
        Demandes & r√©activations
      </button>
    </div>
  </div>

  <!-- ========= ONGLET 1 : STATS ========= -->
  <section *ngIf="activeTab === 'stats'">

    <section class="stats-section">
      <div class="stats-row" *ngIf="!statsLoading && stats; else statsLoadingTpl">
        <article class="stat-card">
          <h3>Chiffre d‚Äôaffaires total</h3>
          <p class="value">{{ stats.totalRevenue | currency:'EUR' }}</p>
          <p class="hint">Toutes commandes confondues</p>
        </article>

        <article class="stat-card">
          <h3>Nombre de commandes</h3>
          <p class="value">{{ stats.totalOrders }}</p>
          <p class="hint">Commandes enregistr√©es</p>
        </article>

        <article class="stat-card">
          <h3>Articles vendus</h3>
          <p class="value">{{ stats.totalItemsSold }}</p>
          <p class="hint">Total des pi√®ces vendues</p>
        </article>

        <article class="stat-card">
          <h3>Panier moyen</h3>
          <p class="value">{{ stats.averageOrderValue | currency:'EUR' }}</p>
          <p class="hint">Montant moyen par commande</p>
        </article>

        <article class="stat-card">
          <h3>Revenu moyen par article</h3>
          <p class="value">
            {{ (stats.totalRevenue / (stats.totalItemsSold || 1)) | currency:'EUR' }}
          </p>
          <p class="hint">Chiffre d‚Äôaffaires √∑ articles vendus</p>
        </article>
      </div>

      <ng-template #statsLoadingTpl>
        <p class="info">Chargement des statistiques...</p>
      </ng-template>

      <p class="info small">
        Ces statistiques sont calcul√©es sur l'ensemble des commandes enregistr√©es (tous statuts confondus).
      </p>

      <p class="error" *ngIf="statsError">{{ statsError }}</p>
    </section>

  </section>

  <!-- ========= ONGLET 2 : GESTION DES COMMANDES ========= -->
  <section *ngIf="activeTab === 'orders'" class="orders-page">

    <div class="orders-header">
      <div>
        <h2>Gestion des commandes</h2>
        <p class="hint">
          Vue globale des commandes clients (c√¥t√© administrateur).
        </p>
      </div>
    </div>

    <p class="info" *ngIf="ordersLoading">Chargement des commandes...</p>
    <p class="error" *ngIf="ordersError">{{ ordersError }}</p>

    <table class="orders-table" *ngIf="!ordersLoading && orders.length > 0">
      <thead>
      <tr>
        <th>R√©f√©rence</th>
        <th>Date</th>
        <th>Statut</th>
        <th>Montant</th>
        <th>D√©tails</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let o of orders">
        <td>{{ o.reference }}</td>
        <td>{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <span class="status-pill" [ngClass]="getStatusClass(o.status)">
            {{ o.status }}
          </span>
        </td>
        <td>{{ o.totalAmount | currency:'EUR' }}</td>
        <td>
          <button class="link-btn" type="button" (click)="openOrderModal(o)">
            D√©tail de la commande
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <p class="info" *ngIf="!ordersLoading && !orders.length">
      Aucune commande pour le moment.
    </p>

    <!-- MODALE D√âTAIL COMMANDE -->
    <div class="modal-overlay" *ngIf="showOrderModal" (click)="closeOrderModal()">
      <div class="modal order-modal" (click)="$event.stopPropagation()">
        <div class="order-modal-header">
          <div>
            <h3>Commande {{ selectedOrder?.reference }}</h3>
            <p class="order-subtitle">
              Cr√©√©e le {{ selectedOrder?.createdAt | date:'dd/MM/yyyy HH:mm' }}
            </p>
          </div>
          <button class="close-btn" type="button" (click)="closeOrderModal()">‚úï</button>
        </div>

        <div class="order-meta">
          <div class="meta-line">
            <span class="label">Statut actuel :</span>
            <span class="status-pill" [ngClass]="getStatusClass(selectedOrder?.status || '')">
              {{ selectedOrder?.status }}
            </span>
          </div>

          <div class="meta-line">
            <span class="label">Montant :</span>
            <span class="value">
              {{ selectedOrder?.totalAmount | currency:'EUR' }}
            </span>
          </div>
        </div>

        <div class="order-status-edit">
          <label for="status-select">Modifier le statut :</label>
          <select id="status-select" [(ngModel)]="modalStatus">
            <option *ngFor="let opt of statusOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>

          <button class="primary small" type="button" (click)="saveOrderStatusFromModal()">
            Mettre √† jour
          </button>
        </div>

        <div class="order-items" *ngIf="selectedOrder">
          <h4>Articles de la commande</h4>
          <ul>
            <li *ngFor="let item of selectedOrder.items">
              <span>{{ item.quantity }} √ó {{ item.productName }}</span>
              <span class="line-price">
                {{ item.unitPrice | currency:'EUR' }}
              </span>
            </li>
          </ul>
        </div>
      </div>
    </div>

  </section>

  <!-- ========= ONGLET 2bis : RETOURS ========= -->
  <section *ngIf="activeTab === 'returns'" class="orders-page returns-page">

    <div class="orders-header">
      <div>
        <h2>Gestion des retours</h2>
        <p class="hint">
          Liste des commandes pour lesquelles un client a demand√© un retour (statut RETURN_REQUESTED).
        </p>
      </div>
    </div>

    <p class="info" *ngIf="ordersLoading">Chargement des retours...</p>
    <p class="error" *ngIf="ordersError">{{ ordersError }}</p>

    <table class="orders-table" *ngIf="!ordersLoading && returnOrders.length > 0">
      <thead>
      <tr>
        <th>R√©f√©rence</th>
        <th>Date</th>
        <th>Statut</th>
        <th>Montant</th>
        <th>D√©tails</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let o of returnOrders">
        <td>{{ o.reference }}</td>
        <td>{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <span class="status-pill" [ngClass]="getStatusClass(o.status)">
            {{ o.status }}
          </span>
        </td>
        <td>{{ o.totalAmount | currency:'EUR' }}</td>
        <td>
          <button class="link-btn" type="button" (click)="openReturnDetails(o)">
            Voir la demande
          </button>
        </td>
        <td class="actions">
          <button class="btn-edit" type="button" (click)="approveReturn(o)">
            ‚úÖ Accepter
          </button>
          <button class="btn-delete" type="button" (click)="openRejectModal(o)">
            ‚ùå Refuser
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <p class="info" *ngIf="!ordersLoading && returnOrders.length === 0">
      Aucun retour demand√© pour le moment.
    </p>
  </section>

  <!-- MODALE D√âTAIL DEMANDE DE RETOUR -->
  <div class="modal-overlay"
       *ngIf="showReturnDetailsModal"
       (click)="closeReturnDetails()">
    <div class="modal order-modal return-modal"
         (click)="$event.stopPropagation()">

      <div class="order-modal-header">
        <div>
          <h3>Demande de retour ‚Äì {{ selectedReturnOrder?.reference }}</h3>
          <p class="order-subtitle">
            Cr√©√©e le {{ selectedReturnOrder?.createdAt | date:'dd/MM/yyyy HH:mm' }}
          </p>
        </div>
        <button class="close-btn" type="button" (click)="closeReturnDetails()">‚úï</button>
      </div>

      <div class="order-meta">
        <div class="meta-line">
          <span class="label">Statut actuel :</span>
          <span class="status-pill"
                [ngClass]="getStatusClass(selectedReturnOrder?.status || '')">
            {{ selectedReturnOrder?.status }}
          </span>
        </div>
        <div class="meta-line">
          <span class="label">Montant :</span>
          <span class="value">
            {{ selectedReturnOrder?.totalAmount | currency:'EUR' }}
          </span>
        </div>
      </div>

      <div class="return-reason-block">
        <h4>Raison du retour (client)</h4>
        <pre class="reason-text">
{{ selectedReturnOrder?.notes || 'Aucun motif enregistr√©.' }}
        </pre>
      </div>
    </div>
  </div>

  <!-- MODALE REFUS RETOUR -->
  <div class="modal-overlay"
       *ngIf="showRejectModal"
       (click)="closeRejectModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Refuser ce retour</h3>
      <p>Expliquez pourquoi le retour est refus√©. Ce message sera envoy√© au client.</p>

      <textarea
        rows="4"
        [(ngModel)]="rejectReason"
        class="reject-textarea"
        placeholder="Exemple : d√©lai de retour d√©pass√©, article utilis√©, conditions non respect√©es...">
      </textarea>

      <div class="modal-actions">
        <button class="btn-cancel" type="button" (click)="closeRejectModal()">Annuler</button>
        <button class="btn-confirm" type="button" (click)="confirmReject()">Confirmer le refus</button>
      </div>
    </div>
  </div>

  <!-- ========= ONGLET 3 : GESTION DES PRODUITS (CRUD) ========= -->
  <section *ngIf="activeTab === 'products'" class="admin-page">

    <div class="admin-header-row">
      <div>
        <h2>Gestion des produits</h2>
        <p class="hint">
          Cr√©e, modifie ou archive les produits de la boutique.
        </p>
      </div>

      <!-- Switch actifs / archiv√©s -->
      <div class="products-mode-switch">
        <button
          type="button"
          class="mode-btn"
          [class.active]="productsMode === 'active'"
          (click)="setProductsMode('active')">
          Produits actifs
        </button>
        <button
          type="button"
          class="mode-btn"
          [class.active]="productsMode === 'archived'"
          (click)="setProductsMode('archived')">
          Produits archiv√©s
        </button>
      </div>
    </div>

    <!-- Bouton cr√©er (uniquement en mode actifs) -->
    <div class="admin-actions" *ngIf="productsMode === 'active'">
      <button
        type="button"
        class="primary"
        (click)="toggleCreateForm()">
        {{ showCreateForm ? 'Fermer le formulaire' : 'Cr√©er un produit' }}
      </button>
    </div>

    <!-- Formulaire cr√©ation / √©dition -->
    <section class="panel create-panel" *ngIf="showCreateForm">
      <h3 class="section-title">
        {{ editingProductId === null ? 'Nouveau produit' : 'Modifier le produit' }}
      </h3>

      <form class="create-form" (ngSubmit)="submitForm()">

        <div class="form-row two-cols">
          <div class="form-group">
            <label for="sku">SKU *</label>
            <input
              id="sku"
              type="text"
              [(ngModel)]="newProduct.sku"
              name="sku" />
          </div>

          <div class="form-group">
            <label for="name">Nom *</label>
            <input
              id="name"
              type="text"
              [(ngModel)]="newProduct.name"
              name="name" />
          </div>
        </div>

        <div class="form-row three-cols">
          <div class="form-group">
            <label for="price">Prix (‚Ç¨) *</label>
            <input
              id="price"
              type="number"
              step="0.01"
              [(ngModel)]="newProduct.price"
              name="price" />
          </div>

          <div class="form-group">
            <label for="material">Mat√©riau</label>
            <input
              id="material"
              type="text"
              [(ngModel)]="newProduct.material"
              name="material" />
          </div>

          <div class="form-group">
            <label for="weight">Poids (g)</label>
            <input
              id="weight"
              type="number"
              [(ngModel)]="newProduct.weightGrams"
              name="weightGrams" />
          </div>
        </div>

        <!-- Segment + type filtr√© -->
        <div class="form-row two-cols">
          <div class="form-group">
            <label for="segmentCategory">Segment *</label>
            <select
              id="segmentCategory"
              [(ngModel)]="newProduct.segmentCategoryId"
              name="segmentCategoryId"
              (ngModelChange)="onSegmentChange()">
              <option [ngValue]="null">-- Choisir un segment --</option>
              <option *ngFor="let s of segmentOptions" [ngValue]="s.id">
                {{ s.label }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="typeCategory">Type de produit *</label>
            <select
              id="typeCategory"
              [(ngModel)]="newProduct.typeCategoryId"
              name="typeCategoryId">
              <option [ngValue]="null">-- Choisir un type --</option>
              <option *ngFor="let t of filteredTypeOptions" [ngValue]="t.id">
                {{ t.label }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            id="description"
            rows="3"
            [(ngModel)]="newProduct.description"
            name="description">
          </textarea>
        </div>

        <div class="form-row two-cols">
          <div class="form-group">
            <!-- Aper√ßu image actuelle (en √©dition) -->
            <div class="current-img-preview" *ngIf="currentImagePreview">
              <div class="preview-label">Image actuelle</div>
              <img [src]="currentImagePreview" alt="Image produit" />
            </div>

            <label for="image">Image du produit {{ editingProductId === null ? '*' : '' }}</label>
            <input
              id="image"
              type="file"
              (change)="onFileSelected($event)" />
            <p class="file-info">
              JPG / PNG, taille raisonnable.
            </p>
          </div>

          <div class="form-footer">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="newProduct.isActive"
                name="isActive" />
              Produit visible sur le site
            </label>
          </div>
        </div>

        <div class="form-footer">
          <span class="info">
            Les champs marqu√©s d‚Äôune * sont obligatoires.
          </span>

          <button
            type="submit"
            class="primary small"
            [disabled]="isSubmitting">
            {{ editingProductId === null ? 'Cr√©er le produit' : 'Enregistrer les modifications' }}
          </button>
        </div>

        <p class="error" *ngIf="error">{{ error }}</p>
      </form>
    </section>

    <!-- Liste des produits -->
    <section class="panel">
      <h3 class="section-title">
        Produits {{ productsMode === 'active' ? 'actifs' : 'archiv√©s' }}
      </h3>

      <div class="state-messages">
        <p class="loading-message" *ngIf="loading">
          <span class="spinner">‚è≥</span> Chargement des produits...
        </p>
        <p class="error-message" *ngIf="!loading && error">
          {{ error }}
        </p>
      </div>

      <table class="product-table" *ngIf="!loading && products.length > 0">
        <thead>
        <tr>
          <th>Image</th>
          <th>Nom</th>
          <th>SKU</th>
          <th>Prix</th>
          <th>Stock</th>
          <th>Actif</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr
          *ngFor="let p of products"
          [class.editing-row]="editingProductId === p.id">

          <td class="product-thumb">
            <img
              *ngIf="p.imageUrls && p.imageUrls.length > 0"
              [src]="'http://localhost:8080' + p.imageUrls[0]"
              [alt]="p.name" />
          </td>

          <td>{{ p.name }}</td>
          <td>{{ p.sku }}</td>
          <td>{{ p.price | currency:'EUR' }}</td>
          <td>{{ p.stockQuantity ?? 0 }}</td>
          <td>{{ p.isActive ? 'Oui' : 'Non' }}</td>

          <td class="actions">
            <!-- Edition uniquement en mode actifs -->
            <button
              type="button"
              class="btn-edit"
              *ngIf="productsMode === 'active'"
              (click)="startEdit(p)">
              √âditer
            </button>

            <!-- Archivage -->
            <button
              type="button"
              class="btn-delete"
              *ngIf="productsMode === 'active'"
              (click)="openDeleteConfirm(p)">
              Archiver
            </button>

            <!-- Restauration -->
            <button
              type="button"
              class="btn-restore"
              *ngIf="productsMode === 'archived'"
              (click)="restoreProduct(p)">
              Restaurer
            </button>
          </td>
        </tr>
        </tbody>
      </table>

      <p class="empty-message" *ngIf="!loading && !products.length">
        Aucun produit {{ productsMode === 'active' ? 'actif' : 'archiv√©' }} pour le moment.
      </p>
    </section>
  </section>

  <!-- MODALE CONFIRMATION SUPPRESSION PRODUIT -->
  <div
    class="modal-overlay"
    *ngIf="showDeleteConfirm"
    (click)="cancelDelete()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Archiver ce produit ?</h3>
      <p>
        Le produit <strong>{{ deleteTargetName }}</strong> sera retir√© du catalogue
        public, mais restera disponible dans la liste des produits archiv√©s.
      </p>
      <div class="modal-actions">
        <button
          type="button"
          class="btn-cancel"
          (click)="cancelDelete()">
          Annuler
        </button>
        <button
          type="button"
          class="btn-confirm-delete"
          (click)="confirmDelete()">
          Confirmer l‚Äôarchivage
        </button>
      </div>
    </div>
  </div>

  <!-- ========= ONGLET 4 : GESTION DU STOCK ========= -->
  <section *ngIf="activeTab === 'stock'" class="stock-section">

    <div class="stock-header">
      <div>
        <h2>Gestion du stock</h2>
        <p class="hint">
          Surveille les produits en quantit√© faible et mets √† jour le stock.
        </p>
      </div>

      <div class="threshold-control">
        <label for="threshold">Seuil d‚Äôalerte :</label>
        <input
          id="threshold"
          type="number"
          min="0"
          [(ngModel)]="lowStockThreshold"
          (change)="onThresholdChange()"
          [ngModelOptions]="{ standalone: true }" />
      </div>
    </div>

    <p class="info" *ngIf="lowStockLoading">Chargement des produits en stock faible...</p>
    <p class="error" *ngIf="lowStockError">{{ lowStockError }}</p>

    <table class="stock-table" *ngIf="!lowStockLoading && lowStockProducts.length > 0">
      <thead>
      <tr>
        <th>Produit</th>
        <th>SKU</th>
        <th>Stock actuel</th>
        <th>Mettre √† jour</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let p of lowStockProducts">
        <td>{{ p.name }}</td>
        <td>{{ p.sku }}</td>
        <td>{{ p.stockQuantity ?? 0 }}</td>
        <td>
          <input
            type="number"
            min="0"
            [(ngModel)]="p.stockQuantity"
            [ngModelOptions]="{ standalone: true }"
            style="width: 80px; margin-right: 0.4rem;" />
          <button
            type="button"
            class="primary small"
            (click)="saveStock(p)">
            Enregistrer
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <p class="info" *ngIf="!lowStockLoading && !lowStockProducts.length">
      Aucun produit n‚Äôest en dessous du seuil de {{ lowStockThreshold }} unit√©s.
    </p>
  </section>

  <!-- ========= ONGLET 5 : GESTION DES AVIS ========= -->
  <section *ngIf="activeTab === 'reviews'" class="reviews-tab">
    <app-admin-reviews></app-admin-reviews>
  </section>

  <!-- ‚úÖ ONGLET SUPPORT (ADMIN + SUPER_ADMIN) -->
  <section *ngIf="activeTab === 'support' && isAdminOrSuperAdmin" class="support-tab">
    <app-super-admin-contact-messages></app-super-admin-contact-messages>
  </section>

  <!-- ========= ONGLET 6 : GESTION DES UTILISATEURS (SUPER ADMIN) ========= -->
  <section *ngIf="activeTab === 'users' && isSuperAdmin" class="users-tab">
    <app-super-admin-users></app-super-admin-users>
  </section>

  <!-- ========= ONGLET 7 : DEMANDES & R√âACTIVATIONS (SUPER ADMIN) ========= -->
  <section *ngIf="activeTab === 'requests' && isSuperAdmin" class="requests-tab">
    <app-super-admin-requests></app-super-admin-requests>
  </section>

</div>
