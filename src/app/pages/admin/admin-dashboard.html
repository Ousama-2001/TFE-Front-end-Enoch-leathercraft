<div class="admin-dashboard">

  <!-- HEADER + ONGLET -->
  <div class="admin-header">
    <h1>Tableau de bord administrateur</h1>
    <p class="subtitle">
      Gestion des ventes, des produits, du stock et des utilisateurs pour Enoch Leathercraft.
    </p>

    <div class="admin-tabs">
      <button class="tab-btn"
              [class.active]="activeTab === 'stats'"
              (click)="setTab('stats')">
        Statistiques de vente
      </button>

      <button class="tab-btn"
              [class.active]="activeTab === 'orders'"
              (click)="setTab('orders')">
        Commandes
      </button>

      <!-- üÜï Onglet retours -->
      <button class="tab-btn"
              [class.active]="activeTab === 'returns'"
              (click)="setTab('returns')">
        Retours
      </button>

      <button class="tab-btn"
              [class.active]="activeTab === 'products'"
              (click)="setTab('products')">
        Gestion des produits
      </button>

      <button class="tab-btn"
              [class.active]="activeTab === 'stock'"
              (click)="setTab('stock')">
        Gestion du stock
      </button>

      <button class="tab-btn"
              [class.active]="activeTab === 'reviews'"
              (click)="setTab('reviews')">
        Gestion des avis
      </button>

      <!-- üîê Onglets r√©serv√©s au SUPER ADMIN -->
      <button class="tab-btn"
              *ngIf="isSuperAdmin"
              [class.active]="activeTab === 'users'"
              (click)="setTab('users')">
        Gestion des utilisateurs
      </button>

      <button class="tab-btn"
              *ngIf="isSuperAdmin"
              [class.active]="activeTab === 'requests'"
              (click)="setTab('requests')">
        Demandes & r√©activations
      </button>
    </div>
  </div>

  <!-- ========= ONGLET 1 : STATS ========= -->
  <section *ngIf="activeTab === 'stats'">

    <section class="stats-section">
      <div class="stats-row" *ngIf="!statsLoading && stats; else statsLoadingTpl">
        <article class="stat-card">
          <h3>Chiffre d‚Äôaffaires total</h3>
          <p class="value">{{ stats.totalRevenue | currency:'EUR' }}</p>
          <p class="hint">Toutes commandes confondues</p>
        </article>

        <article class="stat-card">
          <h3>Nombre de commandes</h3>
          <p class="value">{{ stats.totalOrders }}</p>
          <p class="hint">Commandes enregistr√©es</p>
        </article>

        <article class="stat-card">
          <h3>Articles vendus</h3>
          <p class="value">{{ stats.totalItemsSold }}</p>
          <p class="hint">Total des pi√®ces vendues</p>
        </article>

        <article class="stat-card">
          <h3>Panier moyen</h3>
          <p class="value">{{ stats.averageOrderValue | currency:'EUR' }}</p>
          <p class="hint">Montant moyen par commande</p>
        </article>

        <article class="stat-card">
          <h3>Revenu moyen par article</h3>
          <p class="value">
            {{ (stats.totalRevenue / (stats.totalItemsSold || 1)) | currency:'EUR' }}
          </p>
          <p class="hint">Chiffre d‚Äôaffaires √∑ articles vendus</p>
        </article>
      </div>

      <ng-template #statsLoadingTpl>
        <p class="info">Chargement des statistiques...</p>
      </ng-template>

      <p class="info small">
        Ces statistiques sont calcul√©es sur l'ensemble des commandes enregistr√©es (tous statuts confondus).
      </p>

      <p class="error" *ngIf="statsError">{{ statsError }}</p>
    </section>

  </section>

  <!-- ========= ONGLET 2 : GESTION DES COMMANDES ========= -->
  <section *ngIf="activeTab === 'orders'" class="orders-page">

    <div class="orders-header">
      <div>
        <h2>Gestion des commandes</h2>
        <p class="hint">
          Vue globale des commandes clients (c√¥t√© administrateur).
        </p>
      </div>
    </div>

    <p class="info" *ngIf="ordersLoading">Chargement des commandes...</p>
    <p class="error" *ngIf="ordersError">{{ ordersError }}</p>

    <table class="orders-table" *ngIf="!ordersLoading && orders.length > 0">
      <thead>
      <tr>
        <th>R√©f√©rence</th>
        <th>Date</th>
        <th>Statut</th>
        <th>Montant</th>
        <th>D√©tails</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let o of orders">
        <td>{{ o.reference }}</td>
        <td>{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <span class="status-pill" [ngClass]="getStatusClass(o.status)">
            {{ o.status }}
          </span>
        </td>
        <td>{{ o.totalAmount | currency:'EUR' }}</td>
        <td>
          <button class="link-btn" type="button" (click)="openOrderModal(o)">
            D√©tail de la commande
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <p class="info" *ngIf="!ordersLoading && !orders.length">
      Aucune commande pour le moment.
    </p>

    <!-- MODALE D√âTAIL COMMANDE -->
    <div class="modal-overlay" *ngIf="showOrderModal" (click)="closeOrderModal()">
      <div class="modal order-modal" (click)="$event.stopPropagation()">
        <div class="order-modal-header">
          <div>
            <h3>Commande {{ selectedOrder?.reference }}</h3>
            <p class="order-subtitle">
              Cr√©√©e le {{ selectedOrder?.createdAt | date:'dd/MM/yyyy HH:mm' }}
            </p>
          </div>
          <button class="close-btn" type="button" (click)="closeOrderModal()">‚úï</button>
        </div>

        <div class="order-meta">
          <div class="meta-line">
            <span class="label">Statut actuel :</span>
            <span class="status-pill" [ngClass]="getStatusClass(selectedOrder?.status || '')">
              {{ selectedOrder?.status }}
            </span>
          </div>

          <div class="meta-line">
            <span class="label">Montant :</span>
            <span class="value">
              {{ selectedOrder?.totalAmount | currency:'EUR' }}
            </span>
          </div>
        </div>

        <div class="order-status-edit">
          <label for="status-select">Modifier le statut :</label>
          <select id="status-select" [(ngModel)]="modalStatus">
            <option *ngFor="let opt of statusOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>

          <button class="primary small" type="button" (click)="saveOrderStatusFromModal()">
            Mettre √† jour
          </button>
        </div>

        <div class="order-items" *ngIf="selectedOrder">
          <h4>Articles de la commande</h4>
          <ul>
            <li *ngFor="let item of selectedOrder.items">
              <span>{{ item.quantity }} √ó {{ item.productName }}</span>
              <span class="line-price">
                {{ item.unitPrice | currency:'EUR' }}
              </span>
            </li>
          </ul>
        </div>
      </div>
    </div>

  </section>

  <!-- ========= ONGLET 2bis : RETOURS ========= -->
  <section *ngIf="activeTab === 'returns'" class="orders-page returns-page">

    <div class="orders-header">
      <div>
        <h2>Gestion des retours</h2>
        <p class="hint">
          Liste des commandes pour lesquelles un client a demand√© un retour (statut RETURN_REQUESTED).
        </p>
      </div>
    </div>

    <p class="info" *ngIf="ordersLoading">Chargement des retours...</p>
    <p class="error" *ngIf="ordersError">{{ ordersError }}</p>

    <table class="orders-table" *ngIf="!ordersLoading && returnOrders.length > 0">
      <thead>
      <tr>
        <th>R√©f√©rence</th>
        <th>Date</th>
        <th>Statut</th>
        <th>Montant</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let o of returnOrders">
        <td>{{ o.reference }}</td>
        <td>{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <span class="status-pill" [ngClass]="getStatusClass(o.status)">
            {{ o.status }}
          </span>
        </td>
        <td>{{ o.totalAmount | currency:'EUR' }}</td>
      </tr>
      </tbody>
    </table>

    <p class="info" *ngIf="!ordersLoading && returnOrders.length === 0">
      Aucun retour demand√© pour le moment.
    </p>
  </section>

  <!-- ========= ONGLET 3 : GESTION DES PRODUITS (CRUD) ========= -->
  <section *ngIf="activeTab === 'products'" class="admin-page">

    <div class="admin-header-row">
      <div>
        <h2>Gestion des produits</h2>
        <p class="subtitle">Cr√©ation, √©dition, archivage et restauration des produits.</p>
      </div>

      <div class="admin-actions" *ngIf="productsMode === 'active'">
        <button class="primary" (click)="toggleCreateForm()">
          {{ showCreateForm ? 'Fermer le formulaire' : '+ Ajouter un produit' }}
        </button>
      </div>
    </div>

    <!-- üîÄ Switch actifs / archiv√©s -->
    <div class="products-mode-switch">
      <button
        type="button"
        class="mode-btn"
        [class.active]="productsMode === 'active'"
        (click)="setProductsMode('active')">
        Produits actifs
      </button>

      <button
        type="button"
        class="mode-btn"
        [class.active]="productsMode === 'archived'"
        (click)="setProductsMode('archived')">
        Produits archiv√©s
      </button>
    </div>

    <div class="state-messages">
      <p *ngIf="loading" class="loading-message">
        <span class="spinner">‚è≥</span> Chargement des produits...
      </p>

      <p *ngIf="error" class="error-message">
        ‚ö†Ô∏è Erreur : {{ error }}
      </p>
    </div>

    <!-- Formulaire cr√©ation / √©dition (UNIQUEMENT mode actifs) -->
    <div class="panel create-panel" *ngIf="showCreateForm && productsMode === 'active'">

      <h2>{{ editingProductId ? 'Modifier le produit' : 'Nouveau produit' }}</h2>

      <form (ngSubmit)="submitForm()" class="create-form">
        <div class="form-row two-cols">
          <div class="form-group">
            <label>Nom *</label>
            <input type="text" [(ngModel)]="newProduct.name" name="name" required />
          </div>

          <div class="form-group">
            <label>SKU *</label>
            <input type="text" [(ngModel)]="newProduct.sku" name="sku" required />
          </div>
        </div>

        <div class="form-group">
          <label>Image principale {{ editingProductId ? '(Laisser vide pour garder l\'actuelle)' : '*' }}</label>

          <div class="current-img-preview" *ngIf="currentImagePreview && !selectedFile">
            <p class="preview-label">Image actuelle :</p>
            <img [src]="currentImagePreview" alt="Aper√ßu produit">
          </div>

          <input
            type="file"
            name="image"
            (change)="onFileSelected($event)"
            [required]="editingProductId === null"
            accept="image/jpeg, image/png"
          />

          <p class="file-info" *ngIf="selectedFile">
            Fichier s√©lectionn√© (remplacera l'actuelle) :
            <strong>{{ selectedFile.name }}</strong>
          </p>
        </div>

        <div class="form-row three-cols">
          <div class="form-group">
            <label>Prix (‚Ç¨)</label>
            <input type="number" step="0.01" [(ngModel)]="newProduct.price" name="price" />
          </div>

          <div class="form-group">
            <label>Poids (g)</label>
            <input type="number" [(ngModel)]="newProduct.weightGrams" name="weightGrams" />
          </div>

          <div class="form-group">
            <label>Mat√©riau</label>
            <input type="text" [(ngModel)]="newProduct.material" name="material" />
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea rows="3" [(ngModel)]="newProduct.description" name="description"></textarea>
        </div>

        <div class="form-footer">
          <label>
            <input type="checkbox" [(ngModel)]="newProduct.isActive" name="isActive" />
            Produit actif
          </label>

          <button type="submit" class="primary" [disabled]="isSubmitting">
            <span *ngIf="isSubmitting">‚è≥ Traitement en cours...</span>
            <span *ngIf="!isSubmitting">
              {{ editingProductId ? 'Mettre √† jour le produit' : 'Cr√©er le produit' }}
            </span>
          </button>
        </div>
      </form>
    </div>

    <!-- Liste des produits -->
    <div class="panel">
      <h2 class="section-title">
        {{ productsMode === 'active' ? 'Produits existants' : 'Produits archiv√©s' }}
      </h2>

      <p *ngIf="!loading && products.length === 0 && !error" class="empty-message">
        Aucun produit trouv√© dans ce mode.
      </p>

      <table class="product-table" *ngIf="products.length > 0">
        <thead>
        <tr>
          <th>ID</th>
          <th>IMAGE</th>
          <th>NOM</th>
          <th>PRIX</th>
          <th>SKU</th>
          <th>ACTIF</th>
          <th>ACTIONS</th>
        </tr>
        </thead>

        <tbody>
        <tr *ngFor="let p of products" [class.editing-row]="editingProductId === p.id">
          <td>{{ p.id }}</td>

          <td class="product-thumb">
            <img
              [src]="p.imageUrls && p.imageUrls.length > 0
                       ? ('http://localhost:8080' + p.imageUrls[0])
                       : 'assets/img/products/placeholder-thumb.jpg'"
              [alt]="p.name"
            />
          </td>

          <td>{{ p.name }}</td>
          <td>{{ p.price | currency:'EUR' }}</td>
          <td>{{ p.sku }}</td>
          <td>{{ p.isActive ? 'Oui' : 'Non' }}</td>

          <td class="actions">
            <!-- Mode actifs : modifier / supprimer -->
            <ng-container *ngIf="productsMode === 'active'; else archivedActions">
              <button class="btn-edit" (click)="startEdit(p)">‚úèÔ∏è Modifier</button>
              <button class="btn-delete" (click)="openDeleteConfirm(p)">üóëÔ∏è Supprimer</button>
            </ng-container>

            <!-- Mode archiv√©s : restaurer -->
            <ng-template #archivedActions>
              <button class="btn-restore" type="button" (click)="restoreProduct(p)">
                ‚Ü© Restaurer
              </button>
            </ng-template>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Modale suppression produit -->
    <div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="cancelDelete()">
      <div class="modal" (click)="$event.stopPropagation()">
        <h3>Confirmer la suppression</h3>
        <p>Archiver (soft delete) <strong>{{ deleteTargetName }}</strong> ?</p>

        <div class="modal-actions">
          <button class="btn-cancel" (click)="cancelDelete()">Annuler</button>
          <button class="btn-confirm-delete" (click)="confirmDelete()">Oui, archiver</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ========= ONGLET 4 : GESTION DU STOCK ========= -->
  <section *ngIf="activeTab === 'stock'" class="stock-page">

    <h2>Gestion du stock</h2>
    <p class="subtitle">
      Surveillez les produits en stock faible et mettez √† jour les quantit√©s.
    </p>

    <div class="stock-header">
      <h3>Produits en stock faible</h3>

      <div class="threshold-control">
        <label for="threshold">Seuil d‚Äôalerte :</label>
        <input
          id="threshold"
          type="number"
          min="0"
          [(ngModel)]="lowStockThreshold"
          (ngModelChange)="onThresholdChange()"
        />
      </div>
    </div>

    <p class="info" *ngIf="lowStockLoading">Chargement des produits en stock faible...</p>
    <p class="error" *ngIf="lowStockError">{{ lowStockError }}</p>

    <table class="stock-table" *ngIf="!lowStockLoading && lowStockProducts.length > 0">
      <thead>
      <tr>
        <th>Produit</th>
        <th>SKU</th>
        <th>Prix</th>
        <th>Stock actuel</th>
        <th>Mettre √† jour</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let p of lowStockProducts">
        <td>{{ p.name }}</td>
        <td>{{ p.sku }}</td>
        <td>{{ p.price | currency:'EUR' }}</td>
        <td>
          <input
            type="number"
            min="0"
            [(ngModel)]="p.stockQuantity"
            style="width: 80px; padding: 0.15rem 0.35rem; border-radius: 8px;
                   border: 1px solid rgba(148,163,184,0.5); background:#020617; color:#e5e7eb;"
          />
        </td>
        <td>
          <button class="btn-edit" (click)="saveStock(p)">
            Sauvegarder
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <p class="info" *ngIf="!lowStockLoading && !lowStockProducts.length">
      Aucun produit en dessous du seuil de {{ lowStockThreshold }} unit√©s.
    </p>
  </section>

  <!-- ========= ONGLET 5 : GESTION DES AVIS ========= -->
  <section *ngIf="activeTab === 'reviews'" class="reviews-tab">
    <app-admin-reviews></app-admin-reviews>
  </section>

  <!-- ========= ONGLET 6 : GESTION DES UTILISATEURS (SUPER ADMIN) ========= -->
  <section *ngIf="activeTab === 'users' && isSuperAdmin" class="users-tab">
    <app-super-admin-users></app-super-admin-users>
  </section>

  <!-- ========= ONGLET 7 : DEMANDES & R√âACTIVATIONS (SUPER ADMIN) ========= -->
  <section *ngIf="activeTab === 'requests' && isSuperAdmin" class="requests-tab">
    <app-super-admin-requests></app-super-admin-requests>
  </section>

</div>
