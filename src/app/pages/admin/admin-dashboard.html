<div class="admin-dashboard">

  <div class="admin-header">
    <div class="left">
      <h1>Tableau de bord administrateur</h1>
      <p class="subtitle">Gestion des ventes, des produits, du stock et des promotions.</p>
    </div>
  </div>

  <div class="admin-tabs">
    <button class="tab-btn" [class.active]="activeTab === 'stats'" (click)="setTab('stats')">Stats</button>
    <button class="tab-btn" [class.active]="activeTab === 'orders'" (click)="setTab('orders')">Commandes</button>
    <button class="tab-btn" [class.active]="activeTab === 'returns'" (click)="setTab('returns')">Retours</button>
    <button class="tab-btn" [class.active]="activeTab === 'products'" (click)="setTab('products')">Produits</button>
    <button class="tab-btn" [class.active]="activeTab === 'promotions'" (click)="setTab('promotions')">Promos / Coupons</button>
    <button class="tab-btn" [class.active]="activeTab === 'stock'" (click)="setTab('stock')">Stock</button>
    <button class="tab-btn" [class.active]="activeTab === 'reviews'" (click)="setTab('reviews')">Avis</button>
    <button class="tab-btn" [class.active]="activeTab === 'support'" (click)="setTab('support')">Contact</button>

    <button *ngIf="isSuperAdmin" class="tab-btn" [class.active]="activeTab === 'users'" (click)="setTab('users')">Utilisateurs</button>
    <button *ngIf="isSuperAdmin" class="tab-btn" [class.active]="activeTab === 'requests'" (click)="setTab('requests')">Demandes</button>
  </div>

  <div class="admin-content">

    <section *ngIf="activeTab === 'stats'" class="panel">
      <div class="panel-head"><h2>Statistiques</h2></div>
      <div *ngIf="statsLoading" class="muted">Chargement…</div>
      <div *ngIf="statsError" class="error">{{ statsError }}</div>

      <div *ngIf="stats" class="grid-3">
        <div class="kpi">
          <div class="kpi-label">Chiffre d’affaires</div>
          <div class="kpi-value">{{ stats.totalRevenue | currency:'EUR' }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Commandes</div>
          <div class="kpi-value">{{ stats.totalOrders }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Panier moyen</div>
          <div class="kpi-value">{{ stats.averageOrderValue | currency:'EUR' }}</div>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'orders'" class="panel">
      <div class="panel-head">
        <h2>Commandes</h2>
        <div class="filters">
          <select [(ngModel)]="orderStatusFilter">
            <option value="ALL">Toutes</option>
            <option value="PENDING">En attente</option>
            <option value="PAID">Payées</option>
            <option value="SHIPPED">Expédiées</option>
            <option value="DELIVERED">Livrées</option>
            <option value="CANCELLED">Annulées</option>
            <option value="RETURN_REQUESTED">Retour demandé</option>
          </select>
        </div>
      </div>

      <div *ngIf="ordersLoading" class="muted">Chargement…</div>
      <div class="table-wrap" *ngIf="!ordersLoading">
        <table class="table">
          <thead>
          <tr>
            <th>Réf</th>
            <th>Date</th>
            <th>Client</th>
            <th>Total</th>
            <th>Statut</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let o of filteredOrders">
            <td class="mono">{{ o.reference }}</td>
            <td>{{ o.createdAt | date:'dd/MM/yy HH:mm' }}</td>
            <td>{{ getOrderEmail(o) }}</td>
            <td>{{ o.totalAmount | currency:'EUR' }}</td>
            <td>
              <span class="status-pill" [ngClass]="getStatusClass(o.status)">{{ o.status }}</span>
            </td>
            <td class="right">
              <button class="btn small" (click)="openOrderModal(o)">Détails</button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section *ngIf="activeTab === 'returns'" class="panel">
      <div class="panel-head"><h2>Retours</h2></div>
      <div class="table-wrap">
        <table class="table">
          <thead>
          <tr>
            <th>Réf</th>
            <th>Date</th>
            <th>Total</th>
            <th>Statut</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let o of sortedReturnOrdersAll">
            <td class="mono">{{ o.reference }}</td>
            <td>{{ o.createdAt | date:'dd/MM/yy HH:mm' }}</td>
            <td>{{ o.totalAmount | currency:'EUR' }}</td>
            <td><span class="status-pill" [ngClass]="getStatusClass(o.status)">{{ o.status }}</span></td>
            <td class="right">
              <div class="row-actions" style="justify-content:flex-end;">
                <button class="btn small" (click)="openReturnDetails(o)">Détails</button>
                <button *ngIf="o.status === 'RETURN_REQUESTED'" class="btn small ok" (click)="approveReturn(o)">Accepter</button>
                <button *ngIf="o.status === 'RETURN_REQUESTED'" class="btn small danger" (click)="openRejectModal(o)">Refuser</button>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section *ngIf="activeTab === 'products'" class="panel">

      <div class="panel-head">
        <h2>Produits</h2>
        <div class="right">
          <button class="btn small ghost" [class.active]="productsMode === 'active'" (click)="setProductsMode('active')">Actifs</button>
          <button class="btn small ghost" [class.active]="productsMode === 'archived'" (click)="setProductsMode('archived')">Archivés</button>
          <button class="btn small primary" *ngIf="productsMode === 'active'" (click)="openCreateProduct()">+ Nouveau produit</button>
        </div>
      </div>

      <div class="card dark" id="product-form-panel" *ngIf="showProductForm && productsMode === 'active'">

        <div class="form-title-row">
          <h3 style="margin:0;">{{ editingProductId ? 'Modifier le produit' : 'Créer un produit' }}</h3>
          <span class="pill pill-soft">{{ editingProductId ? 'Édition' : 'Nouveau' }}</span>
        </div>

        <div class="row-2">
          <div><label>Nom *</label><input [(ngModel)]="newProduct.name" placeholder="Nom du produit" /></div>
          <div>
            <label>SKU *</label>
            <div class="row-actions" style="justify-content:flex-start; gap:8px; align-items:center;">
              <input [(ngModel)]="newProduct.sku" (input)="onSkuManualInput()" placeholder="SKU" />
              <button type="button" class="btn small ghost" (click)="resetSkuAuto()">Auto</button>
            </div>
          </div>
        </div>

        <div class="row-2">
          <div>
            <label>Segment *</label>
            <select [(ngModel)]="newProduct.segmentCategoryId" (change)="onSegmentChange()">
              <option [ngValue]="null">Choix...</option>
              <option *ngFor="let s of segmentOptions" [ngValue]="s.id">{{ s.label }}</option>
            </select>
          </div>
          <div>
            <label>Type *</label>
            <select [(ngModel)]="newProduct.typeCategoryId" (change)="onTypeChange()">
              <option [ngValue]="null">Choix...</option>
              <option *ngFor="let t of filteredTypeOptions" [ngValue]="t.id">{{ t.label }}</option>
            </select>
          </div>
        </div>

        <div class="row-2">
          <div><label>Prix (€) *</label><input type="number" min="0" [(ngModel)]="newProduct.price" (input)="clampPrice()" /></div>
          <div><label>Poids (g)</label><input type="number" min="0" [(ngModel)]="newProduct.weightGrams" /></div>
        </div>

        <label>Description</label>
        <textarea [(ngModel)]="newProduct.description" rows="3"></textarea>

        <div class="divider"></div>
        <div class="section-head" style="margin-bottom: 10px; display:flex; align-items:center; justify-content:space-between;">
          <h4 style="margin:0;">Promotion</h4>

          <button class="btn small" type="button"
                  [ngClass]="hasPromo ? 'danger' : 'primary'"
                  (click)="togglePromo()">
            {{ hasPromo ? 'Retirer la promo' : 'Activer une promo' }}
          </button>
        </div>

        <div *ngIf="hasPromo" class="promo-box">
          <div class="row-2">
            <div>
              <label>Prix promo (€)</label>
              <input type="number" min="0" [(ngModel)]="newProduct.promoPrice" (input)="clampPromoPrice()" />
            </div>
            <div>
              <label>Date Début</label>
              <input type="date" [(ngModel)]="newProduct.promoStartAt" />
            </div>
            <div>
              <label>Date Fin</label>
              <input type="date" [(ngModel)]="newProduct.promoEndAt" />
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="section-head">
          <h4 style="margin:0;">Images</h4>
        </div>

        <div class="image-upload-area">
          <input type="file" multiple (change)="onFilesSelected($event)" id="fileInput" class="hidden-input"/>
          <label for="fileInput" class="upload-btn">
            <span>+ Ajouter des images</span>
          </label>
        </div>

        <div class="admin-img-grid">
          <div class="admin-img-thumb" *ngFor="let url of currentImagesFromApi">
            <img [src]="url" alt="Produit">
            <div class="overlay">
              <span class="badge-old">Actuelle</span>
            </div>
          </div>

          <div class="admin-img-thumb new" *ngFor="let img of selectedPreviews; let i = index">
            <img [src]="img" alt="Preview">
            <button type="button" class="x-remove" (click)="removeSelectedFile(i)">×</button>
          </div>
        </div>

        <div class="row-actions" style="margin-top:20px;">
          <button class="btn primary" (click)="submitForm()" [disabled]="isSubmitting">
            {{ editingProductId ? 'Enregistrer les modifications' : 'Créer le produit' }}
          </button>
          <button class="btn ghost" type="button" (click)="closeProductForm()">Annuler</button>
        </div>
      </div>

      <div class="table-wrap" *ngIf="!loading">
        <table class="table">
          <thead>
          <tr><th>SKU</th><th>Nom</th><th>Prix</th><th>Stock</th><th>Promo</th><th>Actions</th></tr>
          </thead>
          <tbody>
          <tr *ngFor="let p of products">
            <td class="mono">{{ p.sku }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.price | currency:'EUR' }}</td>
            <td>{{ p.stockQuantity ?? 0 }}</td>
            <td><span class="pill" [ngClass]="getPromoStatusClass(p)">{{ getPromoStatusLabel(p) }}</span></td>
            <td class="right">
              <div class="row-actions" style="justify-content:flex-end; gap:8px;">
                <button class="btn small" (click)="startEdit(p)">Éditer</button>
                <ng-container *ngIf="productsMode === 'active'">
                  <button class="btn small danger" (click)="openDeleteConfirm(p)">Archiver</button>
                </ng-container>
                <ng-container *ngIf="productsMode === 'archived'">
                  <button class="btn small ok" (click)="restoreProduct(p)">Restaurer</button>
                </ng-container>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section *ngIf="activeTab === 'promotions'" class="panel">
      <div class="panel-head"><h2>Promos / Coupons</h2></div>

      <div class="promo-layout">
        <div class="card dark">
          <div class="form-title-row">
            <h3>{{ editingCouponId ? 'Modifier' : 'Créer un coupon' }}</h3>
          </div>

          <label>Code *</label>
          <input [(ngModel)]="couponForm.code" placeholder="EX: NOEL20" />

          <div class="row-2">
            <div><label>Réduction (%)</label><input type="number" [(ngModel)]="couponForm.percent" (input)="clampCouponPercent()" /></div>
            <div>
              <label>Actif</label>
              <select [(ngModel)]="couponForm.active">
                <option [ngValue]="true">Oui</option>
                <option [ngValue]="false">Non</option>
              </select>
            </div>
          </div>

          <div class="row-2">
            <div><label>Début</label><input type="date" [(ngModel)]="couponForm.startsAt" /></div>
            <div><label>Fin</label><input type="date" [(ngModel)]="couponForm.endsAt" /></div>
          </div>

          <label>Max usages</label>
          <input type="number" [(ngModel)]="couponForm.maxUses" />

          <div class="row-actions">
            <button class="btn primary" (click)="submitCouponForm()" [disabled]="couponSubmitting">Enregistrer</button>
            <button class="btn ghost" (click)="resetCouponForm()">Reset</button>
          </div>
        </div>

        <div class="card dark">
          <div class="section-head"><h3>Liste des coupons</h3></div>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>Code</th><th>%</th><th>Statut</th><th></th></tr></thead>
              <tbody>
              <tr *ngFor="let c of coupons">
                <td class="mono">{{ c.code }}</td>
                <td><b>{{ c.percent }}%</b></td>
                <td><span class="pill" [ngClass]="getCouponStatusClass(c)">{{ getCouponStatusLabel(c) }}</span></td>
                <td class="right">
                  <div class="row-actions" style="justify-content:flex-end; gap:5px;">
                    <button class="btn small" (click)="editCoupon(c)">Edit</button>
                    <button class="btn small danger" (click)="deleteCoupon(c)">X</button>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'stock'" class="panel">
      <div class="panel-head">
        <h2>Gestion Stock</h2>
        <div class="filters">
          <label class="muted small" style="margin-right:8px;">Seuil alerte</label>
          <input type="number" min="0" style="width:80px;" [(ngModel)]="lowStockThreshold" (input)="onThresholdChange()" />
        </div>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>SKU</th><th>Nom</th><th>Stock Actuel</th><th>Action</th></tr></thead>
          <tbody>
          <tr *ngFor="let p of lowStockProducts">
            <td class="mono">{{ p.sku }}</td>
            <td>{{ p.name }}</td>
            <td style="width:120px;"><input type="number" min="0" [(ngModel)]="p.stockQuantity" /></td>
            <td class="right"><button class="btn small primary" (click)="saveStock(p)">Sauvegarder</button></td>
          </tr>
          </tbody>
        </table>
        <div *ngIf="lowStockProducts.length === 0" class="muted small" style="padding:10px;">Aucun produit sous le seuil d'alerte.</div>
      </div>
    </section>

    <section *ngIf="activeTab === 'reviews'" class="panel"><app-admin-reviews></app-admin-reviews></section>
    <section *ngIf="activeTab === 'support'" class="panel"><app-super-admin-contact-messages></app-super-admin-contact-messages></section>
    <section *ngIf="activeTab === 'users'" class="panel"><app-super-admin-users></app-super-admin-users></section>
    <section *ngIf="activeTab === 'requests'" class="panel"><app-super-admin-requests></app-super-admin-requests></section>

  </div>

  <div class="modal-backdrop" *ngIf="showDeleteConfirm">
    <div class="modal">
      <h3>Archiver le produit ?</h3>
      <p>Confirmer l'archivage de <b>{{ deleteTargetName }}</b> ?</p>
      <div class="modal-actions">
        <button class="btn ghost" (click)="cancelDelete()">Annuler</button>
        <button class="btn danger" (click)="confirmDelete()">Confirmer</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showOrderModal && selectedOrder">
    <div class="modal wide">
      <div class="modal-top">
        <h3>Commande {{ selectedOrder.reference }}</h3>
        <button class="xclose" (click)="closeOrderModal()">×</button>
      </div>
      <div class="divider"></div>

      <div class="row-2">
        <div>
          <label>Changer Statut</label>
          <select [(ngModel)]="modalStatus">
            <option *ngFor="let s of statusOptions" [value]="s.value">{{ s.label }}</option>
          </select>
        </div>
        <div class="right">
          <div class="muted small">Total</div>
          <div class="big">{{ selectedOrder.totalAmount | currency:'EUR' }}</div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn ghost" (click)="closeOrderModal()">Fermer</button>
        <button class="btn primary" (click)="saveOrderStatusFromModal()">Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showReturnDetailsModal && selectedReturnOrder">
    <div class="modal">
      <div class="modal-top">
        <h3>Retour {{ selectedReturnOrder.reference }}</h3>
        <button class="xclose" (click)="closeReturnDetails()">×</button>
      </div>
      <p>Statut actuel: <b>{{ selectedReturnOrder.status }}</b></p>
      <div class="modal-actions"><button class="btn ghost" (click)="closeReturnDetails()">Fermer</button></div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showRejectModal">
    <div class="modal">
      <h3>Refuser le retour</h3>
      <label>Raison du refus</label>
      <textarea [(ngModel)]="rejectReason" rows="3"></textarea>
      <div class="modal-actions">
        <button class="btn ghost" (click)="closeRejectModal()">Annuler</button>
        <button class="btn danger" (click)="confirmReject()">Refuser</button>
      </div>
    </div>
  </div>

</div>
