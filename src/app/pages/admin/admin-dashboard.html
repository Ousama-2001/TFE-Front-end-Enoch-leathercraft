<div class="admin-dashboard">

  <header class="dashboard-header">
    <h1>Tableau de bord Admin</h1>
    <!-- NOTE: Le bouton de dÃ©connexion redondant a Ã©tÃ© retirÃ© pour la navbar globale -->
  </header>

  <!-- NAVIGATION ONGLETS -->
  <div class="tabs-nav">
    <button
      class="tab-btn"
      [class.active]="activeTab === 'products'"
      (click)="switchTab('products')">
      ğŸ“¦ Produits
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'orders'"
      (click)="switchTab('orders')">
      ğŸšš Commandes
    </button>
  </div>

  <!-- ============================================== -->
  <!-- CONTENU : PRODUITS -->
  <!-- ============================================== -->
  <div *ngIf="activeTab === 'products'" class="tab-content products-tab">

    <div class="toolbar">
      <h2>Gestion du catalogue</h2>
      <button class="btn-create" (click)="toggleCreateForm()">
        {{ showCreateForm ? 'Fermer' : '+ Nouveau Produit' }}
      </button>
    </div>

    <!-- Formulaire -->
    <div *ngIf="showCreateForm" class="create-form-panel">
      <h3>{{ editingProductId ? 'Modifier le produit' : 'CrÃ©er un produit' }}</h3>

      <div class="form-grid">
        <div class="form-group">
          <label>Nom du produit</label>
          <input [(ngModel)]="newProduct.name" placeholder="Ex: Sac Ã  main Cuir" />
        </div>
        <div class="form-group">
          <label>SKU (RÃ©fÃ©rence)</label>
          <input [(ngModel)]="newProduct.sku" placeholder="Ex: BAG-001" />
        </div>
        <div class="form-group">
          <label>Prix (â‚¬)</label>
          <input type="number" [(ngModel)]="newProduct.price" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="newProduct.description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Image du produit</label>
          <input type="file" (change)="onFileSelected($event)" accept="image/*" />

          <div *ngIf="currentImagePreview" class="img-preview">
            <p>Image actuelle :</p>
            <img [src]="currentImagePreview" alt="PrÃ©visualisation" />
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn-cancel" (click)="toggleCreateForm()">Annuler</button>
        <button class="btn-save" (click)="submitForm()" [disabled]="isSubmitting">
          {{ isSubmitting ? 'Sauvegarde...' : 'Enregistrer' }}
        </button>
      </div>
    </div>

    <!-- Liste Produits -->
    <div class="products-list">
      <div *ngIf="loadingProducts" class="loading">Chargement des produits...</div>

      <table *ngIf="!loadingProducts" class="admin-table">
        <thead>
        <tr>
          <th>Image</th>
          <th>Nom</th>
          <th>SKU</th>
          <th>Prix</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let p of products">
          <td>
            <div class="thumb" *ngIf="p.imageUrls && p.imageUrls.length">
              <img [src]="'http://localhost:8080' + p.imageUrls[0]" alt="img">
            </div>
          </td>
          <td>{{ p.name }}</td>
          <td>{{ p.sku }}</td>
          <td>{{ p.price | currency:'EUR' }}</td>
          <td class="actions-cell">
            <button class="btn-icon edit" (click)="startEdit(p)" title="Modifier">âœï¸</button>
            <button class="btn-icon delete" (click)="openDeleteConfirm(p)" title="Supprimer">ğŸ—‘ï¸</button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- CONTENU : COMMANDES -->
  <!-- ============================================== -->
  <div *ngIf="activeTab === 'orders'" class="tab-content orders-tab">

    <div class="toolbar">
      <h2>Suivi des commandes</h2>
      <button class="btn-refresh" (click)="loadOrders()">ğŸ”„ Actualiser</button>
    </div>

    <div *ngIf="loadingOrders" class="loading">Chargement des commandes...</div>

    <table *ngIf="!loadingOrders" class="admin-table">
      <thead>
      <tr>
        <th>RÃ©f</th>
        <th>Date</th>
        <th>Total</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let order of orders">
        <td class="font-mono text-purple">{{ order.reference }}</td>
        <td>{{ order.createdAt | date:'dd/MM/yy HH:mm' }}</td>
        <td class="font-bold">{{ order.totalAmount | currency:'EUR' }}</td>
        <td>
            <span [ngClass]="getStatusColor(order.status)" class="status-badge">
              {{ order.status }}
            </span>
        </td>
        <td class="actions-cell flex-gap">

          <!-- Ã‰TAPE 1 : PENDING -> PAID (Validation du paiement) -->
          <button *ngIf="order.status === 'PENDING'"
                  (click)="updateOrderStatus(order.id, 'PAID')"
                  class="btn-status btn-pay" title="Confirmer la rÃ©ception du paiement">
            ğŸ’° Valider Paiement
          </button>

          <!-- Ã‰TAPE 2 : PAID -> SHIPPED (ExpÃ©dition) -->
          <button *ngIf="order.status === 'PAID'"
                  (click)="updateOrderStatus(order.id, 'SHIPPED')"
                  class="btn-status btn-ship" title="Envoyer le colis">
            ğŸ“¦ ExpÃ©dier
          </button>

          <!-- Ã‰TAPE 3 : SHIPPED -> DELIVERED (Livraison) -->
          <button *ngIf="order.status === 'SHIPPED'"
                  (click)="updateOrderStatus(order.id, 'DELIVERED')"
                  class="btn-status btn-deliver" title="Confirmer la livraison">
            âœ… Livrer
          </button>

          <!-- ANNULATION (Possible tant que pas livrÃ©) -->
          <button *ngIf="order.status === 'PENDING' || order.status === 'PAID'"
                  (click)="updateOrderStatus(order.id, 'CANCELLED')"
                  class="btn-status btn-cancel">
            âœ– Annuler
          </button>

          <!-- STATUT FINAL -->
          <span *ngIf="order.status === 'DELIVERED'" class="text-success">âœ… TerminÃ©</span>
          <span *ngIf="order.status === 'CANCELLED'" class="text-error">ğŸš« AnnulÃ©</span>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Popup Suppression (Produits) -->
  <div class="modal-overlay" *ngIf="showDeleteConfirm">
    <div class="modal-box">
      <h3>Confirmer la suppression</h3>
      <p>Voulez-vous vraiment supprimer "<strong>{{ deleteTargetName }}</strong>" ?</p>
      <div class="modal-actions">
        <button (click)="cancelDelete()" class="btn-cancel">Non</button>
        <button (click)="confirmDelete()" class="btn-delete-confirm">Oui, supprimer</button>
      </div>
    </div>
  </div>

</div>
