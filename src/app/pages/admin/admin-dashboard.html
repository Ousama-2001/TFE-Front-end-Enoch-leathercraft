<div class="admin-dashboard">

  <div class="admin-header">
    <div class="left">
      <h1>Tableau de bord administrateur</h1>
      <p class="subtitle">Gestion des ventes, des produits, du stock et des promotions.</p>
    </div>

    <!-- ✅ supprimé : bouton Déconnexion -->
  </div>

  <!-- TABS -->
  <div class="admin-tabs">
    <button class="tab-btn" [class.active]="activeTab === 'stats'" (click)="setTab('stats')">Stats</button>
    <button class="tab-btn" [class.active]="activeTab === 'orders'" (click)="setTab('orders')">Commandes</button>
    <button class="tab-btn" [class.active]="activeTab === 'returns'" (click)="setTab('returns')">Retours</button>
    <button class="tab-btn" [class.active]="activeTab === 'products'" (click)="setTab('products')">Produits</button>
    <button class="tab-btn" [class.active]="activeTab === 'promotions'" (click)="setTab('promotions')">Promos / Coupons</button>
    <button class="tab-btn" [class.active]="activeTab === 'stock'" (click)="setTab('stock')">Stock</button>
    <button class="tab-btn" [class.active]="activeTab === 'reviews'" (click)="setTab('reviews')">Avis</button>
    <button class="tab-btn" [class.active]="activeTab === 'support'" (click)="setTab('support')">Contact</button>

    <button *ngIf="isSuperAdmin" class="tab-btn" [class.active]="activeTab === 'users'" (click)="setTab('users')">Utilisateurs</button>
    <button *ngIf="isSuperAdmin" class="tab-btn" [class.active]="activeTab === 'requests'" (click)="setTab('requests')">Demandes</button>
  </div>

  <div class="admin-content">

    <!-- ===================== STATS ===================== -->
    <section *ngIf="activeTab === 'stats'" class="panel">
      <div class="panel-head">
        <h2>Statistiques</h2>
      </div>

      <div *ngIf="statsLoading" class="muted">Chargement…</div>
      <div *ngIf="statsError" class="error">{{ statsError }}</div>

      <div *ngIf="stats" class="grid-3">
        <div class="kpi">
          <div class="kpi-label">Chiffre d’affaires</div>
          <div class="kpi-value">{{ stats.totalRevenue | currency:'EUR' }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Commandes</div>
          <div class="kpi-value">{{ stats.totalOrders }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Panier moyen</div>
          <div class="kpi-value">{{ stats.averageOrderValue | currency:'EUR' }}</div>
        </div>
      </div>
    </section>

    <!-- ===================== COMMANDES ===================== -->
    <section *ngIf="activeTab === 'orders'" class="panel">
      <div class="panel-head">
        <h2>Commandes</h2>

        <div class="filters">
          <select [(ngModel)]="orderStatusFilter">
            <option value="ALL">Toutes</option>
            <option value="PENDING">En attente</option>
            <option value="PAID">Payées</option>
            <option value="SHIPPED">Expédiées</option>
            <option value="DELIVERED">Livrées</option>
            <option value="CANCELLED">Annulées</option>
            <option value="RETURN_REQUESTED">Retour demandé</option>
            <option value="RETURN_APPROVED">Retour accepté</option>
            <option value="RETURN_REJECTED">Retour refusé</option>
          </select>
        </div>
      </div>

      <div *ngIf="ordersLoading" class="muted">Chargement…</div>
      <div *ngIf="ordersError" class="error">{{ ordersError }}</div>

      <div class="table-wrap" *ngIf="!ordersLoading">
        <table class="table">
          <thead>
          <tr>
            <th>Réf</th>
            <th>Date</th>
            <th>Client</th>
            <th>Total</th>
            <th>Statut</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let o of filteredOrders">
            <td class="mono">{{ o.reference }}</td>
            <td>{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ getOrderEmail(o) }}</td>
            <td>{{ o.totalAmount | currency:'EUR' }}</td>
            <td>
              <span class="status-pill" [ngClass]="getStatusClass(o.status)">
                {{ o.status }}
              </span>
            </td>
            <td class="right">
              <button class="btn small" (click)="openOrderModal(o)">Détails</button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ===================== RETOURS ===================== -->
    <section *ngIf="activeTab === 'returns'" class="panel">
      <div class="panel-head">
        <h2>Retours</h2>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
          <tr>
            <th>Réf</th>
            <th>Date</th>
            <th>Client</th>
            <th>Total</th>
            <th>Statut</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let o of sortedReturnOrdersAll">
            <td class="mono">{{ o.reference }}</td>
            <td>{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ getOrderEmail(o) }}</td>
            <td>{{ o.totalAmount | currency:'EUR' }}</td>
            <td>
              <span class="status-pill" [ngClass]="getStatusClass(o.status)">
                {{ o.status }}
              </span>
            </td>
            <td class="right">
              <div class="row-actions" style="justify-content:flex-end; gap:8px;">
                <button class="btn small" (click)="openReturnDetails(o)">Détails</button>
                <button class="btn small ok" (click)="approveReturn(o)" *ngIf="o.status === 'RETURN_REQUESTED'">Accepter</button>
                <button class="btn small danger" (click)="openRejectModal(o)" *ngIf="o.status === 'RETURN_REQUESTED'">Refuser</button>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ===================== PRODUITS ===================== -->
    <section *ngIf="activeTab === 'products'" class="panel">

      <div class="panel-head">
        <div>
          <h2>Produits</h2>
        </div>

        <div class="right">
          <button class="btn small ghost"
                  [class.active]="productsMode === 'active'"
                  (click)="setProductsMode('active')">
            Actifs
          </button>
          <button class="btn small ghost"
                  [class.active]="productsMode === 'archived'"
                  (click)="setProductsMode('archived')">
            Archivés
          </button>

          <button class="btn small primary"
                  *ngIf="productsMode === 'active'"
                  (click)="openCreateProduct()">
            + Nouveau produit
          </button>
        </div>
      </div>

      <div *ngIf="loading" class="muted">Chargement…</div>
      <div *ngIf="error" class="error">{{ error }}</div>

      <!-- FORM PRODUIT -->
      <div class="card dark" id="product-form-panel" *ngIf="showProductForm && productsMode === 'active'">

        <div class="form-title-row">
          <h3 style="margin:0;">
            {{ editingProductId ? 'Modifier le produit' : 'Créer un produit' }}
          </h3>
          <span class="pill pill-soft" *ngIf="editingProductId">Édition</span>
          <span class="pill pill-soft" *ngIf="!editingProductId">Création</span>
        </div>

        <div class="row-2">
          <div>
            <label>Nom *</label>
            <input [(ngModel)]="newProduct.name" placeholder="Ex: Sac bandoulière" />
          </div>

          <div>
            <label>SKU *</label>
            <div class="row-actions" style="justify-content:flex-start; gap:8px; align-items:center;">
              <input [(ngModel)]="newProduct.sku"
                     (input)="onSkuManualInput()"
                     placeholder="Ex: HOM-BAG-12345" />
              <button type="button" class="btn small ghost" (click)="resetSkuAuto()">SKU auto</button>
            </div>
          </div>
        </div>

        <div class="row-2">
          <div>
            <label>Segment *</label>
            <select [(ngModel)]="newProduct.segmentCategoryId" (change)="onSegmentChange()">
              <option [ngValue]="null">— Choisir —</option>
              <option *ngFor="let s of segmentOptions" [ngValue]="s.id">{{ s.label }}</option>
            </select>
          </div>

          <div>
            <label>Type *</label>
            <select [(ngModel)]="newProduct.typeCategoryId" (change)="onTypeChange()">
              <option [ngValue]="null">— Choisir —</option>
              <option *ngFor="let t of filteredTypeOptions" [ngValue]="t.id">{{ t.label }}</option>
            </select>
          </div>
        </div>

        <div class="row-2">
          <div>
            <label>Prix (€) *</label>
            <input type="number" min="0" [(ngModel)]="newProduct.price" (input)="clampPrice()" />
          </div>

          <div>
            <label>Poids (g)</label>
            <input type="number" min="0" [(ngModel)]="newProduct.weightGrams" />
          </div>
        </div>

        <label>Description</label>
        <textarea [(ngModel)]="newProduct.description" rows="4" placeholder="Description du produit..."></textarea>

        <!-- PROMO (date only / sans promoCode / sans texte dessous) -->
        <div class="divider"></div>
        <div class="section-head">
          <h4 style="margin:0;">Promotion (optionnel)</h4>
          <span class="pill" [ngClass]="newProduct.promoPrice ? 'promo-active' : 'promo-inactive'">
            {{ newProduct.promoPrice ? 'Promo activée' : 'Aucune promo' }}
          </span>
        </div>

        <div class="row-2">
          <div>
            <label>Prix promo (€)</label>
            <input type="number" min="0" [(ngModel)]="newProduct.promoPrice" (input)="clampPromoPrice()" />
          </div>
          <div>
            <label>Début (date)</label>
            <input type="date" [(ngModel)]="newProduct.promoStartAt" />
          </div>
        </div>

        <div class="row-2">
          <div>
            <label>Fin (date)</label>
            <input type="date" [(ngModel)]="newProduct.promoEndAt" />
          </div>
          <div class="ghost-card">
            <div class="muted small">Astuce</div>
            <div class="small">Si tu mets un prix promo, la date du jour se met automatiquement si vide.</div>
          </div>
        </div>

        <!-- IMAGES -->
        <div class="divider"></div>
        <div class="section-head">
          <h4 style="margin:0;">Images</h4>
          <span class="pill pill-soft">{{ selectedFiles.length || 0 }} sélectionnée(s)</span>
        </div>

        <input type="file" multiple (change)="onFilesSelected($event)" />

        <div class="grid-3" *ngIf="selectedPreviews.length" style="margin-top:12px;">
          <div class="img-card" *ngFor="let img of selectedPreviews; let i = index">
            <img [src]="img" alt="preview" />
            <button type="button" class="btn small danger" (click)="removeSelectedFile(i)">Retirer</button>
          </div>
        </div>

        <div *ngIf="currentImagesFromApi.length" style="margin-top:12px;">
          <div class="grid-3" style="margin-top:8px;">
            <div class="img-card" *ngFor="let url of currentImagesFromApi">
              <img [src]="url" alt="product-img" />
            </div>
          </div>
        </div>

        <div class="row-actions" style="margin-top:14px;">
          <button class="btn primary" (click)="submitForm()" [disabled]="isSubmitting">
            {{ isSubmitting ? 'Envoi…' : (editingProductId ? 'Enregistrer' : 'Créer') }}
          </button>
          <button class="btn ghost" type="button" (click)="closeProductForm()">Annuler</button>
        </div>
      </div>

      <!-- LISTE PRODUITS -->
      <div class="table-wrap" *ngIf="!loading">
        <table class="table">
          <thead>
          <tr>
            <th>SKU</th>
            <th>Nom</th>
            <th>Prix</th>
            <th>Stock</th>
            <th>Promo</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let p of products">
            <td class="mono">{{ p.sku }}</td>
            <td class="cell-main">
              <div class="cell-title">{{ p.name }}</div>
              <div class="cell-sub muted small" *ngIf="p.segmentSlug || p.typeSlug">
                <span *ngIf="p.segmentSlug">{{ p.segmentSlug }}</span>
                <span *ngIf="p.segmentSlug && p.typeSlug"> • </span>
                <span *ngIf="p.typeSlug">{{ p.typeSlug }}</span>
              </div>
            </td>
            <td>{{ p.price | currency:'EUR' }}</td>
            <td>
              <span class="pill pill-soft">{{ p.stockQuantity ?? 0 }}</span>
            </td>
            <td>
              <span class="pill" [ngClass]="getPromoStatusClass(p)">
                {{ getPromoStatusLabel(p) }}
              </span>
            </td>
            <td class="right">
              <ng-container *ngIf="productsMode === 'active'; else archivedActions">
                <div class="row-actions" style="justify-content:flex-end; gap:8px;">
                  <button class="btn small" (click)="startEdit(p)">Éditer</button>
                  <button class="btn small danger" (click)="openDeleteConfirm(p)">Archiver</button>
                </div>
              </ng-container>

              <ng-template #archivedActions>
                <button class="btn small ok" (click)="restoreProduct(p)">Restaurer</button>
              </ng-template>
            </td>
          </tr>
          </tbody>
        </table>

        <div class="muted small" *ngIf="!products.length && !loading">
          Aucun produit.
        </div>
      </div>

    </section>

    <!-- ===================== PROMOS / COUPONS ===================== -->
    <section *ngIf="activeTab === 'promotions'" class="panel">
      <div class="panel-head">
        <div>
          <h2>Promos / Coupons</h2>
        </div>
      </div>

      <div *ngIf="couponsLoading" class="muted">Chargement…</div>
      <div *ngIf="couponsError" class="error">{{ couponsError }}</div>

      <div class="promo-layout">
        <div class="card dark">
          <div class="form-title-row">
            <h3 style="margin:0;">{{ editingCouponId ? 'Modifier coupon' : 'Créer un coupon' }}</h3>
            <span class="pill pill-soft" *ngIf="editingCouponId">Édition</span>
            <span class="pill pill-soft" *ngIf="!editingCouponId">Création</span>
          </div>

          <label>Code *</label>
          <input [(ngModel)]="couponForm.code" placeholder="EX: NOEL-20" />

          <div class="row-2">
            <div>
              <label>Réduction (%) *</label>
              <input type="number" [(ngModel)]="couponForm.percent" (input)="clampCouponPercent()" />
            </div>
            <div>
              <label>Actif</label>
              <select [(ngModel)]="couponForm.active">
                <option [ngValue]="true">Oui</option>
                <option [ngValue]="false">Non</option>
              </select>
            </div>
          </div>

          <div class="row-2">
            <div>
              <label>Début (date)</label>
              <input type="date" [(ngModel)]="couponForm.startsAt" />
            </div>
            <div>
              <label>Fin (date)</label>
              <input type="date" [(ngModel)]="couponForm.endsAt" />
            </div>
          </div>

          <label>Utilisations max (optionnel)</label>
          <input type="number" [(ngModel)]="couponForm.maxUses" placeholder="Ex: 200" />

          <div class="row-actions">
            <button class="btn primary" (click)="submitCouponForm()" [disabled]="couponSubmitting">
              {{ couponSubmitting ? 'Envoi…' : (editingCouponId ? 'Enregistrer' : 'Créer') }}
            </button>
            <button class="btn ghost" type="button" (click)="resetCouponForm()">Reset</button>
          </div>
        </div>

        <div class="card dark">
          <div class="section-head" style="margin-bottom:10px;">
            <h3 style="margin:0;">Coupons</h3>
            <span class="pill pill-soft">{{ coupons.length || 0 }}</span>
          </div>

          <div class="table-wrap">
            <table class="table">
              <thead>
              <tr>
                <th>Code</th>
                <th>%</th>
                <th>Fenêtre</th>
                <th>Statut</th>
                <th></th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let c of coupons">
                <td class="mono">{{ c.code }}</td>
                <td><b>{{ c.percent }}%</b></td>

                <td class="muted small">
                  <div *ngIf="c.startsAt">Début: {{ c.startsAt | date:'dd/MM/yyyy' }}</div>
                  <div *ngIf="c.endsAt">Fin: {{ c.endsAt | date:'dd/MM/yyyy' }}</div>
                  <div *ngIf="!c.startsAt && !c.endsAt">—</div>
                </td>

                <td>
                  <span class="pill" [ngClass]="getCouponStatusClass(c)">
                    {{ getCouponStatusLabel(c) }}
                  </span>
                </td>

                <td class="right">
                  <div class="row-actions" style="justify-content:flex-end; gap:8px;">
                    <button class="btn small" (click)="editCoupon(c)">Éditer</button>
                    <button class="btn small" (click)="toggleCouponActive(c)">
                      {{ c.active ? 'Désactiver' : 'Activer' }}
                    </button>
                    <button class="btn small danger" (click)="deleteCoupon(c)">Supprimer</button>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>

          <div class="muted small" *ngIf="!coupons.length && !couponsLoading">
            Aucun coupon.
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== STOCK ===================== -->
    <section *ngIf="activeTab === 'stock'" class="panel">
      <div class="panel-head">
        <div>
          <h2>Stock</h2>
        </div>

        <div class="filters">
          <label class="muted small" style="margin-right:8px;">Seuil</label>
          <input type="number" min="0" style="width:90px;"
                 [(ngModel)]="lowStockThreshold"
                 (input)="onThresholdChange()" />
        </div>
      </div>

      <div *ngIf="lowStockLoading" class="muted">Chargement…</div>
      <div *ngIf="lowStockError" class="error">{{ lowStockError }}</div>

      <div class="table-wrap" *ngIf="!lowStockLoading">
        <table class="table">
          <thead>
          <tr>
            <th>SKU</th>
            <th>Nom</th>
            <th>Stock</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let p of lowStockProducts">
            <td class="mono">{{ p.sku }}</td>
            <td>{{ p.name }}</td>
            <td style="max-width:140px;">
              <input type="number" min="0" [(ngModel)]="p.stockQuantity" />
            </td>
            <td class="right">
              <button class="btn small primary" (click)="saveStock(p)">Enregistrer</button>
            </td>
          </tr>
          </tbody>
        </table>

        <div class="muted small" *ngIf="!lowStockProducts.length && !lowStockLoading">
          Aucun produit sous le seuil.
        </div>
      </div>
    </section>

    <!-- ===================== AVIS ===================== -->
    <section *ngIf="activeTab === 'reviews'" class="panel">
      <app-admin-reviews></app-admin-reviews>
    </section>

    <!-- ===================== SUPPORT ===================== -->
    <section *ngIf="activeTab === 'support'" class="panel">
      <app-super-admin-contact-messages></app-super-admin-contact-messages>
    </section>

    <!-- ===================== SUPER ADMIN ===================== -->
    <section *ngIf="activeTab === 'users'" class="panel">
      <app-super-admin-users></app-super-admin-users>
    </section>

    <section *ngIf="activeTab === 'requests'" class="panel">
      <app-super-admin-requests></app-super-admin-requests>
    </section>

  </div>

  <!-- ===================== MODALE SUPPRESSION PRODUIT ===================== -->
  <div class="modal-backdrop" *ngIf="showDeleteConfirm">
    <div class="modal">
      <h3>Archiver le produit</h3>
      <p>Confirmer l’archivage de <b>{{ deleteTargetName }}</b> ?</p>

      <div class="modal-actions">
        <button class="btn ghost" (click)="cancelDelete()">Annuler</button>
        <button class="btn danger" (click)="confirmDelete()">Archiver</button>
      </div>
    </div>
  </div>

  <!-- ===================== MODALE DETAIL COMMANDE ===================== -->
  <div class="modal-backdrop" *ngIf="showOrderModal && selectedOrder">
    <div class="modal wide">
      <div class="modal-top">
        <h3>Détails commande <span class="mono">{{ selectedOrder.reference }}</span></h3>
        <button class="xclose" (click)="closeOrderModal()">×</button>
      </div>

      <div class="muted small">
        {{ selectedOrder.createdAt | date:'dd/MM/yyyy HH:mm' }} • {{ getOrderEmail(selectedOrder) }}
      </div>

      <div class="divider"></div>

      <div class="row-2">
        <div>
          <label>Statut</label>
          <select [(ngModel)]="modalStatus">
            <option *ngFor="let s of statusOptions" [value]="s.value">{{ s.label }}</option>
          </select>
        </div>
        <div class="right">
          <div class="muted small">Total</div>
          <div class="big">{{ selectedOrder.totalAmount | currency:'EUR' }}</div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn ghost" (click)="closeOrderModal()">Fermer</button>
        <button class="btn primary" (click)="saveOrderStatusFromModal()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- ===================== MODALES RETOUR ===================== -->
  <div class="modal-backdrop" *ngIf="showReturnDetailsModal && selectedReturnOrder">
    <div class="modal">
      <div class="modal-top">
        <h3>Retour - {{ selectedReturnOrder.reference }}</h3>
        <button class="xclose" (click)="closeReturnDetails()">×</button>
      </div>

      <p class="muted small">Statut: <b>{{ selectedReturnOrder.status }}</b></p>

      <div class="modal-actions">
        <button class="btn ghost" (click)="closeReturnDetails()">Fermer</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showRejectModal && selectedReturnOrder">
    <div class="modal">
      <div class="modal-top">
        <h3>Refuser le retour</h3>
        <button class="xclose" (click)="closeRejectModal()">×</button>
      </div>

      <label>Raison</label>
      <textarea [(ngModel)]="rejectReason" rows="4"></textarea>

      <div class="modal-actions">
        <button class="btn ghost" (click)="closeRejectModal()">Annuler</button>
        <button class="btn danger" (click)="confirmReject()">Refuser</button>
      </div>
    </div>
  </div>

</div>
