<div class="admin-dashboard">

  <div class="admin-header">
    <div class="left">
      <h1>{{ 'admin.title' | t }}</h1>
      <p class="subtitle">{{ 'admin.subtitle' | t }}</p>
    </div>
  </div>

  <div class="admin-tabs">
    <button class="tab-btn" [class.active]="activeTab === 'stats'" (click)="setTab('stats')">{{ 'admin.tabs.stats' | t }}</button>
    <button class="tab-btn" [class.active]="activeTab === 'orders'" (click)="setTab('orders')">{{ 'admin.tabs.orders' | t }}</button>
    <button class="tab-btn" [class.active]="activeTab === 'returns'" (click)="setTab('returns')">{{ 'admin.tabs.returns' | t }}</button>
    <button class="tab-btn" [class.active]="activeTab === 'products'" (click)="setTab('products')">{{ 'admin.tabs.products' | t }}</button>
    <button class="tab-btn" [class.active]="activeTab === 'promotions'" (click)="setTab('promotions')">{{ 'admin.tabs.coupons' | t }}</button>
    <button class="tab-btn" [class.active]="activeTab === 'stock'" (click)="setTab('stock')">{{ 'admin.tabs.stock' | t }}</button>
    <button class="tab-btn" [class.active]="activeTab === 'reviews'" (click)="setTab('reviews')">{{ 'admin.tabs.reviews' | t }}</button>
    <button class="tab-btn" [class.active]="activeTab === 'support'" *ngIf="isAdminOrSuperAdmin" (click)="setTab('support')">{{ 'admin.tabs.contact' | t }}</button>

    <button *ngIf="isSuperAdmin" class="tab-btn" [class.active]="activeTab === 'users'" (click)="setTab('users')">{{ 'admin.tabs.users' | t }}</button>
    <button *ngIf="isSuperAdmin" class="tab-btn" [class.active]="activeTab === 'requests'" (click)="setTab('requests')">{{ 'admin.tabs.requests' | t }}</button>
  </div>

  <div class="admin-content">

    <section *ngIf="activeTab === 'stats'" class="panel">
      <div class="panel-head"><h2>{{ 'admin.tabs.stats' | t }}</h2></div>
      <div *ngIf="statsLoading" class="muted">{{ 'home.latest.loading' | t }}</div>
      <div *ngIf="statsError" class="error">{{ statsError }}</div>

      <div *ngIf="stats" class="grid-3">
        <div class="kpi">
          <div class="kpi-label">{{ 'admin.stats.revenue' | t }}</div>
          <div class="kpi-value">{{ stats.totalRevenue | currency:'EUR' }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">{{ 'admin.stats.orders' | t }}</div>
          <div class="kpi-value">{{ stats.totalOrders }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">{{ 'admin.stats.average' | t }}</div>
          <div class="kpi-value">{{ stats.averageOrderValue | currency:'EUR' }}</div>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'orders'" class="panel">
      <div class="panel-head">
        <h2>{{ 'admin.tabs.orders' | t }}</h2>
        <div class="filters">
          <input type="text" [(ngModel)]="orderSearchTerm" [placeholder]="'products.search.placeholder' | t" class="search-input" />
          <div class="filter-select-wrapper">
            <select [(ngModel)]="orderStatusFilter">
              <option value="ALL">{{ 'admin.order.status.all' | t }}</option>
              <option value="PENDING">{{ 'admin.order.status.pending' | t }}</option>
              <option value="PAID">{{ 'admin.order.status.paid' | t }}</option>
              <option value="SHIPPED">{{ 'admin.order.status.shipped' | t }}</option>
              <option value="DELIVERED">{{ 'admin.order.status.delivered' | t }}</option>
              <option value="CANCELLED">{{ 'admin.order.status.cancelled' | t }}</option>
            </select>
          </div>
        </div>
      </div>

      <div *ngIf="ordersLoading" class="muted">{{ 'home.latest.loading' | t }}</div>
      <div class="table-wrap" *ngIf="!ordersLoading">
        <table class="table">
          <thead>
          <tr>
            <th>{{ 'account.orders.ref' | t }}</th>
            <th>{{ 'account.orders.date' | t }}</th>
            <th>{{ 'admin.orders.client' | t }}</th>
            <th>{{ 'account.orders.total' | t }}</th>
            <th>{{ 'account.orders.status' | t }}</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let o of paginatedOrders">
            <td class="mono" [class.highlight]="orderSearchTerm && o.reference.toLowerCase().includes(orderSearchTerm.toLowerCase())">{{ o.reference }}</td>
            <td>{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ getOrderEmail(o) }}</td>
            <td>{{ o.totalAmount | currency:'EUR' }}</td>
            <td><span class="status-pill" [ngClass]="getStatusClass(o.status)">{{ getStatusLabel(o.status) }}</span></td>
            <td class="right"><button class="btn small" (click)="openOrderModal(o)">{{ 'admin.common.details' | t }}</button></td>
          </tr>
          </tbody>
        </table>
        <div *ngIf="filteredOrders.length === 0" class="muted small center-pad">{{ 'account.orders.empty' | t }}</div>
        <div class="pagination-controls" *ngIf="filteredOrders.length > pageSize">
          <button class="btn small ghost" (click)="changeOrdersPage(-1)" [disabled]="ordersPage === 1">←</button>
          <span class="page-info">{{ ordersPage }} / {{ totalOrdersPages }}</span>
          <button class="btn small ghost" (click)="changeOrdersPage(1)" [disabled]="ordersPage === totalOrdersPages">→</button>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'returns'" class="panel">
      <div class="panel-head">
        <h2>{{ 'admin.tabs.returns' | t }}</h2>
        <div class="filters">
          <input type="text" [(ngModel)]="returnSearchTerm" [placeholder]="'products.search.placeholder' | t" class="search-input" />
          <div class="filter-select-wrapper">
            <select [(ngModel)]="returnStatusFilter">
              <option value="ALL">{{ 'products.filters.category.all' | t }}</option>
              <option *ngFor="let s of returnStatusOptions" [value]="s.value">{{ s.label }}</option>
            </select>
          </div>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>Ref</th><th>Date</th><th>{{ 'admin.orders.client' | t }}</th><th>Total</th><th>Statut</th><th></th></tr></thead>
          <tbody>
          <tr *ngFor="let o of paginatedReturns">
            <td class="mono" [class.highlight]="returnSearchTerm && o.reference.toLowerCase().includes(returnSearchTerm.toLowerCase())">{{ o.reference }}</td>
            <td>{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ getOrderEmail(o) }}</td>
            <td>{{ o.totalAmount | currency:'EUR' }}</td>
            <td><span class="status-pill" [ngClass]="getStatusClass(o.status)">{{ getStatusLabel(o.status) }}</span></td>
            <td class="right"><button class="btn small" (click)="openReturnDetails(o)">{{ 'admin.common.details' | t }}</button></td>
          </tr>
          </tbody>
        </table>
        <div *ngIf="filteredReturns.length === 0" class="muted small center-pad">{{ 'products.empty' | t }}</div>
        <div class="pagination-controls" *ngIf="filteredReturns.length > pageSize">
          <button class="btn small ghost" (click)="changeReturnsPage(-1)" [disabled]="returnsPage === 1">←</button>
          <span class="page-info">{{ returnsPage }} / {{ totalReturnsPages }}</span>
          <button class="btn small ghost" (click)="changeReturnsPage(1)" [disabled]="returnsPage === totalReturnsPages">→</button>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'products'" class="panel">
      <div class="panel-head">
        <h2>{{ 'admin.tabs.products' | t }}</h2>
        <div class="products-toolbar">
          <div class="search-box"><input type="text" [(ngModel)]="productSearchTerm" [placeholder]="'products.search.placeholder' | t" /></div>
          <div class="divider-v"></div>
          <div class="filter-select-wrapper">
            <select [(ngModel)]="selectedProductFilter" (change)="onProductFilterChange()">
              <option value="ALL">{{ 'products.filters.segment.all' | t }}</option>
              <option value="ACTIVE">{{ 'admin.users.status.active' | t }}</option>
              <option value="PROMO">{{ 'products.filters.onSale' | t }}</option>
              <option value="ARCHIVED">{{ 'admin.users.status.deleted' | t }}</option>
            </select>
          </div>
          <button class="btn small primary new-btn" *ngIf="selectedProductFilter !== 'ARCHIVED'" (click)="toggleCreateForm()">
            {{ showCreateForm ? ('admin.common.close' | t) : ('admin.products.new' | t) }}
          </button>
        </div>
      </div>

      <div class="card dark" id="product-form-panel" *ngIf="showCreateForm">
        <div class="form-title-row">
          <h3>{{ editingProductId ? ('admin.products.edit' | t) : ('admin.products.create' | t) }}</h3>
          <span class="pill pill-soft">{{ editingProductId ? ('reviews.edit' | t) : ('home.highlight.newSelection' | t) }}</span>
        </div>
        <div *ngIf="productFormError" class="alert error" style="margin-top: 15px;">⚠️ {{ productFormError }}</div>
        <div class="row-2">
          <div><label>{{ 'cart.table.product' | t }} <span class="req">*</span></label><input [(ngModel)]="newProduct.name" [placeholder]="'cart.table.product' | t" [class.input-error]="!newProduct.name && productFormError" /></div>
          <div><label>{{ 'admin.products.sku' | t }} <span class="req">*</span></label>
            <div class="row-actions" style="justify-content:flex-start; gap:8px; align-items:center;">
              <input [(ngModel)]="newProduct.sku" (input)="onSkuManualInput()" [placeholder]="'admin.products.sku' | t" [class.input-error]="!newProduct.sku && productFormError" />
              <button type="button" class="btn small ghost" (click)="resetSkuAuto()">Auto</button>
            </div>
          </div>
        </div>
        <div class="row-2">
          <div><label>{{ 'admin.products.segment' | t }} <span class="req">*</span></label>
            <select [(ngModel)]="newProduct.segmentCategoryId" (change)="onSegmentChange()" [class.input-error]="!newProduct.segmentCategoryId && productFormError">
              <option [ngValue]="null">...</option>
              <option *ngFor="let s of segmentOptions" [ngValue]="s.id">{{ s.label }}</option>
            </select>
          </div>
          <div><label>{{ 'admin.products.type' | t }} <span class="req">*</span></label>
            <select [(ngModel)]="newProduct.typeCategoryId" (change)="onTypeChange()" [class.input-error]="!newProduct.typeCategoryId && productFormError">
              <option [ngValue]="null">...</option>
              <option *ngFor="let t of filteredTypeOptions" [ngValue]="t.id">{{ t.label }}</option>
            </select>
          </div>
        </div>
        <div class="row-2">
          <div><label>{{ 'cart.table.unitPrice' | t }} (€) <span class="req">*</span></label><input type="number" min="0" [(ngModel)]="newProduct.price" placeholder="0.00" [class.input-error]="newProduct.price == null && productFormError" /></div>
          <div><label>{{ 'admin.products.weight' | t }}</label><input type="number" min="0" [(ngModel)]="newProduct.weightGrams" placeholder="0" /></div>
        </div>
        <label>{{ 'reviews.comment' | t }}</label>
        <div class="textarea-wrapper">
          <textarea [(ngModel)]="newProduct.description" rows="4" maxlength="1000" [placeholder]="'reviews.comment' | t" [class.input-error]="newProduct.description && newProduct.description.length > 1000"></textarea>
          <div class="char-count" [class.limit-reached]="(newProduct.description?.length || 0) >= 1000">{{ newProduct.description?.length || 0 }} / 1000</div>
        </div>
        <div class="divider"></div>
        <div class="section-head" style="margin-bottom: 10px; display:flex; align-items:center; justify-content:space-between;">
          <h4 style="margin:0;">{{ 'products.filters.offers' | t }}</h4>
          <button class="btn small" type="button" [ngClass]="hasPromo ? 'danger' : 'ghost'" (click)="togglePromo()">
            {{ hasPromo ? ('admin.products.promo.disable' | t) : ('admin.products.promo.activate' | t) }}
          </button>
        </div>
        <div *ngIf="hasPromo" class="promo-box">
          <div class="row-2">
            <div><label>{{ 'products.section.promoTitle' | t }} (€) <span class="req">*</span></label><input type="number" min="0" [(ngModel)]="newProduct.promoPrice" placeholder="0.00" [class.input-error]="newProduct.promoPrice == null && productFormError" /></div>
            <div><label>{{ 'account.orders.date' | t }} (Start) <span class="req">*</span></label><input type="date" [(ngModel)]="newProduct.promoStartAt" [class.input-error]="!newProduct.promoStartAt && productFormError" /></div>
            <div><label>{{ 'account.orders.date' | t }} (End)</label><input type="date" [(ngModel)]="newProduct.promoEndAt" /></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="section-head"><h4 style="margin:0;">Images</h4></div>
        <div class="image-upload-area">
          <input type="file" multiple (change)="onFilesSelected($event)" id="fileInput" class="hidden-input"/><label for="fileInput" class="upload-btn"><span>+ Ajouter des images</span></label>
        </div>
        <div class="admin-img-grid">
          <div class="admin-img-thumb" *ngFor="let img of currentImages"><img [src]="img.url" alt="Produit" (click)="openImagePreview(img.url)"><div class="overlay"><span class="badge-old">En ligne</span></div><button type="button" class="x-remove" (click)="deleteExistingImage(img.id)">×</button></div>
          <div class="admin-img-thumb new" *ngFor="let p of selectedPreviews; let i = index"><img [src]="p" alt="Preview" (click)="openImagePreview(p)"><button type="button" class="x-remove" (click)="removeSelectedFile(i)">×</button></div>
        </div>
        <div class="row-actions" style="margin-top:20px;">
          <button class="btn primary" (click)="submitForm()" [disabled]="isSubmitting">{{ editingProductId ? ('reviews.edit.save' | t) : ('admin.products.create' | t) }}</button>
          <button class="btn ghost" type="button" (click)="toggleCreateForm()">{{ 'common.cancel' | t }}</button>
        </div>
      </div>

      <div class="table-wrap" *ngIf="!loading">
        <table class="table">
          <thead><tr><th>IMAGE</th><th>{{ 'cart.table.product' | t }}</th><th>{{ 'admin.products.sku' | t }}</th><th>PRIX UNITAIRE</th><th>STOCK</th><th>STATUT</th><th>ACTION</th></tr></thead>
          <tbody>
          <tr *ngFor="let p of paginatedProducts">
            <td class="product-thumb">
              <img *ngIf="p.imageUrls && p.imageUrls.length > 0" [src]="'http://localhost:8080' + (p.imageUrls[0] || '')" style="width:40px;height:40px;object-fit:cover;border-radius:6px;cursor:pointer;" (click)="openImagePreview('http://localhost:8080' + p.imageUrls[0])">
            </td>
            <td>{{ p.name }}</td>
            <td class="mono" [class.highlight]="productSearchTerm && p.sku.toLowerCase().includes(productSearchTerm.toLowerCase())">{{ p.sku }}</td>
            <td>
              <div *ngIf="p.promoPrice && p.promoPrice > 0; else simplePrice">
                <span class="old-price">{{ p.price | currency:'EUR' }}</span><br><span class="promo-price-tag">{{ p.promoPrice | currency:'EUR' }}</span>
              </div>
              <ng-template #simplePrice>{{ p.price | currency:'EUR' }}</ng-template>
            </td>
            <td><span class="pill pill-soft">{{ p.stockQuantity ?? 0 }}</span></td>
            <td><span class="pill" [ngClass]="getPromoStatusClass(p)">{{ getPromoStatusLabel(p) }}</span></td>
            <td class="right">
              <div class="row-actions" style="justify-content:flex-end;">
                <button class="btn small" *ngIf="selectedProductFilter !== 'ARCHIVED'" (click)="startEdit(p)">{{ 'reviews.edit' | t }}</button>
                <button class="btn small danger" *ngIf="selectedProductFilter !== 'ARCHIVED'" (click)="openDeleteConfirm(p)">{{ 'reviews.delete' | t }}</button>
                <button class="btn small ok" *ngIf="selectedProductFilter === 'ARCHIVED'" (click)="restoreProduct(p)">{{ 'admin.users.action.restore' | t }}</button>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
        <div *ngIf="filteredProducts.length === 0" class="muted small center-pad">{{ 'products.empty' | t }}</div>
        <div class="pagination-controls" *ngIf="filteredProducts.length > pageSize">
          <button class="btn small ghost" (click)="changeProductsPage(-1)" [disabled]="productsPage === 1">←</button>
          <span class="page-info">{{ productsPage }} / {{ totalProductsPages }}</span>
          <button class="btn small ghost" (click)="changeProductsPage(1)" [disabled]="productsPage === totalProductsPages">→</button>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'promotions'" class="panel">
      <div class="panel-head"><h2>{{ 'admin.tabs.coupons' | t }}</h2></div>
      <div class="promo-layout">
        <div class="card dark">
          <div class="form-title-row"><h3>{{ editingCouponId ? ('reviews.edit' | t) : ('admin.products.create' | t) }}</h3></div>
          <label>Code *</label><input [(ngModel)]="couponForm.code" placeholder="EX: NOEL20" />
          <div class="row-2">
            <div><label>Réduction (%)</label><input type="number" min="1" max="99" [(ngModel)]="couponForm.percent" /></div>
            <div><label>Actif</label><select [(ngModel)]="couponForm.active"><option [ngValue]="true">Oui</option><option [ngValue]="false">Non</option></select></div>
          </div>
          <div class="row-2">
            <div><label>Début</label><input type="date" [(ngModel)]="couponForm.startsAt" /></div>
            <div><label>Fin</label><input type="date" [(ngModel)]="couponForm.endsAt" /></div>
          </div>
          <label>Max usages</label><input type="number" min="0" [(ngModel)]="couponForm.maxUses" />
          <div class="row-actions">
            <button class="btn primary" (click)="submitCouponForm()" [disabled]="couponSubmitting">{{ 'reviews.edit.save' | t }}</button>
            <button class="btn ghost" (click)="resetCouponForm()">Reset</button>
          </div>
        </div>
        <div class="card dark">
          <div class="section-head"><h3>Liste</h3></div>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>Code</th><th>%</th><th>Utilisations (Restantes)</th><th>Statut</th><th></th></tr></thead>
              <tbody>
              <tr *ngFor="let c of coupons">
                <td class="mono">{{ c.code }}</td>
                <td><b>{{ c.percent }}%</b></td>
                <td>
                    <span *ngIf="c.maxUses; else unlimited">
                        {{ c.usedCount || 0 }} / {{ c.maxUses }}
                      <span class="muted" style="font-size:11px;">({{ (c.maxUses - (c.usedCount || 0)) > 0 ? (c.maxUses - (c.usedCount || 0)) + ' rest.' : 'Épuisé' }})</span>
                    </span>
                  <ng-template #unlimited>{{ c.usedCount || 0 }} / ∞</ng-template>
                </td>
                <td><span class="pill" [ngClass]="getCouponStatusClass(c)">{{ getCouponStatusLabel(c) }}</span></td>
                <td class="right"><button class="btn small" (click)="editCoupon(c)">{{ 'reviews.edit' | t }}</button><button class="btn small danger" (click)="deleteCoupon(c)">X</button></td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'stock'" class="panel">
      <div class="panel-head">
        <h2>{{ 'admin.tabs.stock' | t }}</h2>
        <div class="filters">
          <label class="muted small" style="margin-right:8px;">Seuil alerte</label>
          <input type="number" min="0" style="width:80px;" [(ngModel)]="lowStockThreshold" (input)="onThresholdChange()" />
        </div>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>{{ 'admin.products.sku' | t }}</th><th>{{ 'cart.table.product' | t }}</th><th>{{ 'admin.tabs.stock' | t }}</th><th>Action</th></tr></thead>
          <tbody>
          <tr *ngFor="let p of lowStockProducts">
            <td class="mono">{{ p.sku }}</td>
            <td>{{ p.name }}</td>
            <td style="width:120px;"><input type="number" min="0" [(ngModel)]="p.stockQuantity" /></td>
            <td class="right"><button class="btn small primary" (click)="saveStock(p)">{{ 'reviews.edit.save' | t }}</button></td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section *ngIf="activeTab === 'reviews'" class="panel"><app-admin-reviews></app-admin-reviews></section>
    <section *ngIf="activeTab === 'support'" class="panel"><app-super-admin-contact-messages></app-super-admin-contact-messages></section>
    <section *ngIf="activeTab === 'users'" class="panel"><app-super-admin-users></app-super-admin-users></section>
    <section *ngIf="activeTab === 'requests'" class="panel"><app-super-admin-requests></app-super-admin-requests></section>

  </div>

  <div class="modal-backdrop" *ngIf="showDeleteConfirm">
    <div class="modal">
      <h3>{{ 'account.confirm.delete' | t }}</h3>
      <p>Confirmer l'archivage de <b>{{ deleteTargetName }}</b> ?</p>
      <div class="modal-actions">
        <button class="btn ghost" (click)="cancelDelete()">{{ 'common.cancel' | t }}</button>
        <button class="btn danger" (click)="confirmDelete()">{{ 'reviews.delete' | t }}</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showOrderModal && selectedOrder">
    <div class="modal wide">
      <div class="modal-top">
        <h3>{{ 'orders.card.titlePrefix' | t }} {{ selectedOrder.reference }}</h3>
        <button class="xclose" (click)="closeOrderModal()">×</button>
      </div>
      <div class="divider"></div>
      <div class="row-2" style="margin-bottom: 20px;">
        <div class="kpi">
          <div class="kpi-label">{{ 'admin.orders.client' | t }}</div>
          <div class="bold-white">{{ getOrderEmail(selectedOrder) }}</div>
          <div class="muted small" *ngIf="(selectedOrder | any)?.userId">ID: {{ (selectedOrder | any)?.userId }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">{{ 'account.orders.total' | t }}</div>
          <div class="kpi-value">{{ selectedOrder.totalAmount | currency:'EUR' }}</div>
        </div>
      </div>
      <div class="row-2">
        <div>
          <label>{{ 'account.orders.status' | t }}</label>
          <select [(ngModel)]="modalStatus">
            <option value="PENDING">{{ 'admin.order.status.pending' | t }}</option>
            <option value="PAID">{{ 'admin.order.status.paid' | t }}</option>
            <option value="SHIPPED">{{ 'admin.order.status.shipped' | t }}</option>
            <option value="DELIVERED">{{ 'admin.order.status.delivered' | t }}</option>
            <option value="CANCELLED">{{ 'admin.order.status.cancelled' | t }}</option>
          </select>
        </div>
        <div><label>{{ 'account.orders.date' | t }}</label><div class="muted" style="margin-top:10px;">{{ selectedOrder.createdAt | date:'dd/MM/yyyy à HH:mm' }}</div></div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" (click)="closeOrderModal()">{{ 'admin.common.close' | t }}</button>
        <button class="btn primary" (click)="saveOrderStatusFromModal()">{{ 'admin.common.save' | t }}</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showReturnDetailsModal && selectedReturnOrder">
    <div class="modal wide">
      <div class="modal-top">
        <h3>{{ 'admin.tabs.returns' | t }} {{ selectedReturnOrder.reference }}</h3>
        <button class="xclose" (click)="closeReturnDetails()">×</button>
      </div>
      <div class="divider"></div>
      <div class="row-2" style="margin-bottom: 20px;">
        <div class="kpi" style="background:rgba(234, 88, 12, 0.1); border:1px solid rgba(234, 88, 12, 0.3);">
          <div class="kpi-label">Client</div>
          <div class="bold-white">{{ getOrderEmail(selectedReturnOrder) }}</div>
        </div>
        <div class="kpi"><div class="kpi-label">Statut Retour</div><div class="kpi-value">{{ selectedReturnOrder.status }}</div></div>
      </div>
      <div class="row-2">
        <div><label>Modifier le statut du retour</label><select [(ngModel)]="modalStatus"><option *ngFor="let s of returnStatusOptions" [value]="s.value">{{ s.label }}</option></select></div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" (click)="closeReturnDetails()">{{ 'admin.common.close' | t }}</button>
        <button class="btn primary" (click)="saveReturnStatusFromModal()">{{ 'admin.common.save' | t }}</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showRejectModal">
    <div class="modal">
      <h3>Refuser le retour</h3>
      <label>Raison</label><textarea [(ngModel)]="rejectReason" rows="3"></textarea>
      <div class="modal-actions"><button class="btn ghost" (click)="closeRejectModal()">{{ 'common.cancel' | t }}</button><button class="btn danger" (click)="confirmReject()">Refuser</button></div>
    </div>
  </div>

  <div class="image-preview-overlay" *ngIf="previewImage" (click)="closeImagePreview()"><div class="preview-content" (click)="$event.stopPropagation()"><img [src]="previewImage" alt="Full Preview"><button class="close-preview" (click)="closeImagePreview()">×</button></div></div>

</div>
