<!-- src/app/pages/products/products.html -->
<div class="products-page">

  <!-- ========= HEADER + SEARCH ========= -->
  <section class="products-hero">
    <div class="auth-warning" *ngIf="authWarning">
      {{ authWarning }}
    </div>
    <div class="hero-text">
      <h1>{{ 'products.hero.title' | t }}</h1>
      <p>
        {{ 'products.hero.subtitle' | t }}
      </p>
    </div>

    <div class="search-wrapper">
      <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input
          type="text"
          [placeholder]="'products.search.placeholder' | t"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onFiltersChange()"
        />
        <button
          class="clear-btn"
          *ngIf="searchTerm"
          type="button"
          (click)="clearSearch()">
          ‚úï
        </button>
      </div>
    </div>
  </section>

  <!-- ========= FILTRES ========= -->
  <section class="filters-row">
    <!-- Segment -->
    <div class="filter-group">
      <label>{{ 'products.filters.segment' | t }}</label>
      <select [(ngModel)]="selectedSegment" (ngModelChange)="onFiltersChange()">
        <option value="">{{ 'products.filters.segment.all' | t }}</option>
        <option value="homme">{{ 'products.filters.segment.men' | t }}</option>
        <option value="femme">{{ 'products.filters.segment.women' | t }}</option>
        <option value="petite-maroquinerie">
          {{ 'products.filters.segment.smallLeather' | t }}
        </option>
      </select>
    </div>

    <!-- Cat√©gorie -->
    <div class="filter-group">
      <label>{{ 'products.filters.category' | t }}</label>
      <select [(ngModel)]="selectedCategory" (ngModelChange)="onFiltersChange()">
        <option value="">{{ 'products.filters.category.all' | t }}</option>
        <option value="sacs-sacoches">
          {{ 'products.filters.category.bags' | t }}
        </option>
        <option value="ceintures">
          {{ 'products.filters.category.belts' | t }}
        </option>
        <option value="portefeuilles">
          {{ 'products.filters.category.wallets' | t }}
        </option>
        <option value="portes-cartes">
          {{ 'products.filters.category.cardHolders' | t }}
        </option>
        <option value="sets-de-table">
          {{ 'products.filters.category.placemats' | t }}
        </option>
      </select>
    </div>

    <!-- Prix -->
    <div class="filter-group">
      <label>{{ 'products.filters.price' | t }}</label>
      <div class="filter-price-inputs">
        <input
          type="number"
          placeholder="Min"
          [(ngModel)]="priceMin"
          (ngModelChange)="onFiltersChange()"
        />
        <span>‚Äì</span>
        <input
          type="number"
          placeholder="Max"
          [(ngModel)]="priceMax"
          (ngModelChange)="onFiltersChange()"
        />
      </div>
    </div>

    <!-- Tri -->
    <div class="filter-group">
      <label>{{ 'products.filters.sort' | t }}</label>
      <select [(ngModel)]="sortBy" (ngModelChange)="onFiltersChange()">
        <option value="">{{ 'products.filters.sort.default' | t }}</option>
        <option value="price-asc">{{ 'products.filters.sort.priceAsc' | t }}</option>
        <option value="price-desc">{{ 'products.filters.sort.priceDesc' | t }}</option>
        <option value="newest">{{ 'products.filters.sort.newest' | t }}</option>
      </select>
    </div>
  </section>

  <!-- ========= LISTE PRODUITS ========= -->
  <section
    class="products-section"
    *ngIf="filteredProducts && filteredProducts.length; else noProducts">

    <h2 class="section-title">{{ 'products.section.title' | t }}</h2>

    <div class="products-grid">

      <!-- SKELETONS SI CHARGEMENT -->
      <ng-container *ngIf="loading; else productsList">
        <article class="product-card skeleton" *ngFor="let _ of skeletonItems">
          <div class="product-image shimmer"></div>
          <div class="product-body">
            <div class="line shimmer"></div>
            <div class="line short shimmer"></div>
          </div>
          <div class="card-footer">
            <div class="price shimmer line short"></div>
          </div>
        </article>
      </ng-container>

      <!-- VRAIS PRODUITS -->
      <ng-template #productsList>
        <article class="product-card" *ngFor="let p of paginatedProducts">

          <div class="product-image">
            <img
              [src]="p.imageUrls && p.imageUrls.length > 0
                      ? ('http://localhost:8080' + p.imageUrls[0])
                      : 'assets/img/products/placeholder-bag.jpg'"
              [alt]="p.name"
            />
            <button
              type="button"
              class="fav-btn"
              (click)="toggleFavorite(p)"
              [class.active]="isFavorite(p)">
              ‚ô•
            </button>
          </div>

          <div class="product-body">
            <h3 class="product-name">{{ p.name }}</h3>

            <p class="product-description" *ngIf="p.description; else noDesc">
              {{ p.description }}
            </p>
            <ng-template #noDesc>
              <p class="product-description muted">
                {{ 'products.description.missing' | t }}
              </p>
            </ng-template>

            <!-- STOCK -->
            <p class="stock-info" *ngIf="p.stockQuantity != null">
              <span *ngIf="p.stockQuantity > 0; else outOfStock">
                {{ 'products.stock.inStockPrefix' | t }}{{ p.stockQuantity }}
                {{ 'products.stock.inStockSuffix' | t }}
              </span>
              <ng-template #outOfStock>
                <span class="out-stock">
                  {{ 'products.stock.outOfStock' | t }}
                </span>
              </ng-template>
            </p>
          </div>

          <div class="card-footer">
            <div class="price">
              {{ p.price | currency : 'EUR' }}
            </div>

            <div class="card-actions">

              <!-- Si pas encore dans le panier -->
              <ng-container *ngIf="getQuantity(p) === 0; else qtyControls">
                <button
                  type="button"
                  class="btn-icon btn-cart"
                  (click)="increase(p)"
                  [disabled]="isAddDisabled(p)"
                  [attr.aria-label]="'product.addToCart' | t">
                  üõí
                </button>
              </ng-container>

              <!-- D√©j√† pr√©sent : pill quantit√© -->
              <ng-template #qtyControls>
                <div class="qty-pill">
                  <button type="button" (click)="decrease(p)">‚àí</button>
                  <span>{{ getQuantity(p) }}</span>
                  <button
                    type="button"
                    (click)="increase(p)"
                    [disabled]="isMaxQuantityReached(p)">
                    +
                  </button>
                </div>
              </ng-template>

              <a
                class="btn-icon btn-eye"
                [routerLink]="['/products', p.id]"
                aria-label="Voir le produit">
                üëÅÔ∏è
              </a>
            </div>

            <p class="stock-warning" *ngIf="isMaxQuantityReached(p)">
              {{ 'products.stock.maxReached' | t }}
            </p>
          </div>
        </article>
      </ng-template>
    </div>

    <!-- PAGINATION -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button
        class="page-btn"
        [disabled]="page === 1"
        (click)="changePage(page - 1)">
        {{ 'products.pagination.prev' | t }}
      </button>

      <span class="page-info">
        {{ 'products.pagination.pageInfo' | t }} {{ page }} / {{ totalPages }}
      </span>

      <button
        class="page-btn"
        [disabled]="page === totalPages"
        (click)="changePage(page + 1)">
        {{ 'products.pagination.next' | t }}
      </button>
    </div>
  </section>

  <ng-template #noProducts>
    <p class="empty-message">
      {{ 'products.empty' | t }}
    </p>
  </ng-template>
</div>
