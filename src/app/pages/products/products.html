<div class="products-page">

  <div class="auth-warning" *ngIf="authWarning">
    {{ authWarning }}
  </div>

  <section class="products-hero">
    <div class="hero-text">
      <h1>{{ 'products.hero.title' | t }}</h1>
      <p>{{ 'products.hero.subtitle' | t }}</p>
    </div>
  </section>

  <section class="filters-card">
    <div class="filters-top">
      <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input
          type="text"
          [placeholder]="'products.search.placeholder' | t"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onFiltersChange()"
        />
        <button class="clear-btn" *ngIf="searchTerm" type="button" (click)="clearSearch()">‚úï</button>
      </div>

      <button type="button" class="btn-reset" (click)="clearAllFilters()">
        {{ 'products.filters.reset' | t }}
      </button>
    </div>

    <div class="filters-grid">
      <div class="filter-group">
        <label>{{ 'products.filters.segment' | t }}</label>
        <select [(ngModel)]="selectedSegment" (ngModelChange)="onFiltersChange()">
          <option value="">{{ 'products.filters.segment.all' | t }}</option>
          <option value="homme">{{ 'products.filters.segment.men' | t }}</option>
          <option value="femme">{{ 'products.filters.segment.women' | t }}</option>
          <option value="petite-maroquinerie">{{ 'products.filters.segment.smallLeather' | t }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>{{ 'products.filters.category' | t }}</label>
        <select [(ngModel)]="selectedCategory" (ngModelChange)="onFiltersChange()">
          <option value="">{{ 'products.filters.category.all' | t }}</option>
          <option value="sacs-sacoches">{{ 'products.filters.category.bags' | t }}</option>
          <option value="ceintures">{{ 'products.filters.category.belts' | t }}</option>
          <option value="portefeuilles">{{ 'products.filters.category.wallets' | t }}</option>
          <option value="portes-cartes">{{ 'products.filters.category.cardHolders' | t }}</option>
          <option value="sets-de-table">{{ 'products.filters.category.placemats' | t }}</option>
        </select>
      </div>

      <div class="filter-group price-group">
        <label>{{ 'products.filters.price' | t }}</label>
        <div class="price-row-container">
          <div class="price-input-wrapper">
            <span class="currency-symbol">‚Ç¨</span>
            <input
              type="number" min="0" step="10" placeholder="Min"
              [(ngModel)]="priceMin" (ngModelChange)="onFiltersChange()" (input)="preventNegative($event)"
            />
          </div>
          <span class="separator">‚Äì</span>
          <div class="price-input-wrapper">
            <span class="currency-symbol">‚Ç¨</span>
            <input
              type="number" min="0" step="10" placeholder="Max"
              [(ngModel)]="priceMax" (ngModelChange)="onFiltersChange()" (input)="preventNegative($event)"
            />
          </div>
        </div>
      </div>

      <div class="filter-group">
        <label>{{ 'products.filters.offers' | t }}</label>
        <button
          type="button"
          class="promo-toggle-btn"
          [class.active]="showPromosOnly"
          (click)="togglePromoFilter()">
          <span class="icon">üè∑Ô∏è</span>
          <span>{{ 'products.filters.onSale' | t }}</span>
        </button>
      </div>

      <div class="filter-group">
        <label>{{ 'products.filters.sort' | t }}</label>
        <select [(ngModel)]="sortBy" (ngModelChange)="onFiltersChange()">
          <option value="">{{ 'products.filters.sort.default' | t }}</option>
          <option value="price-asc">{{ 'products.filters.sort.priceAsc' | t }}</option>
          <option value="price-desc">{{ 'products.filters.sort.priceDesc' | t }}</option>
          <option value="newest">{{ 'products.filters.sort.newest' | t }}</option>
        </select>
      </div>
    </div>
  </section>

  <section class="products-section" *ngIf="filteredProducts && filteredProducts.length; else noProducts">
    <h2 class="section-title">
      {{ showPromosOnly ? ('products.section.promoTitle' | t) : ('products.section.title' | t) }}
    </h2>

    <div class="products-grid">
      <ng-container *ngIf="loading; else productsList">
        <article class="product-card skeleton" *ngFor="let _ of skeletonItems">
          <div class="product-image shimmer"></div>
          <div class="product-body">
            <div class="line shimmer"></div>
          </div>
          <div class="card-footer">
            <div class="price shimmer line short"></div>
          </div>
        </article>
      </ng-container>

      <ng-template #productsList>
        <article class="product-card" *ngFor="let p of paginatedProducts">
          <div class="product-image">
            <img [src]="productService.getImageUrl(p)" [alt]="p.name" />
            <div class="discount-badge" *ngIf="productService.isPromoValid(p)">
              -{{ productService.getDiscountPercent(p) }}%
            </div>
            <button type="button" class="fav-btn" (click)="toggleFavorite(p)" [class.active]="isFavorite(p)">
              ‚ô•
            </button>
          </div>

          <div class="product-body">
            <h3 class="product-name">{{ p.name }}</h3>
            <p class="stock-info" *ngIf="p.stockQuantity != null">
              <span *ngIf="p.stockQuantity > 0; else outOfStock">
                {{ 'products.stock.inStockPrefix' | t }}{{ p.stockQuantity }} {{ 'products.stock.inStockSuffix' | t }}
              </span>
              <ng-template #outOfStock>
                <span class="out-stock">{{ 'products.stock.outOfStock' | t }}</span>
              </ng-template>
            </p>
          </div>

          <div class="card-footer">
            <div class="price-box">
              <ng-container *ngIf="productService.isPromoValid(p); else normalPrice">
                <div class="price-stack">
                  <span class="old-price">{{ p.price | currency : 'EUR' }}</span>
                  <span class="current-price promo">{{ productService.getEffectivePrice(p) | currency : 'EUR' }}</span>
                </div>
              </ng-container>
              <ng-template #normalPrice>
                <span class="current-price">{{ p.price | currency : 'EUR' }}</span>
              </ng-template>
            </div>

            <div class="card-actions">
              <ng-container *ngIf="getQuantity(p) === 0; else qtyControls">
                <button type="button" class="btn-icon btn-cart" (click)="increase(p)" [disabled]="isAddDisabled(p)">
                  üõí
                </button>
              </ng-container>
              <ng-template #qtyControls>
                <div class="qty-pill">
                  <button type="button" (click)="decrease(p)">‚àí</button>
                  <span>{{ getQuantity(p) }}</span>
                  <button type="button" (click)="increase(p)" [disabled]="isMaxQuantityReached(p)">+</button>
                </div>
              </ng-template>
              <a class="btn-icon btn-eye" [routerLink]="['/products', p.id]">üëÅÔ∏è</a>
            </div>
          </div>
        </article>
      </ng-template>
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
      <button class="page-btn" [disabled]="page === 1" (click)="changePage(page - 1)">
        {{ 'products.pagination.prev' | t }}
      </button>
      <span class="page-info">
        {{ 'products.pagination.pageInfo' | t }} {{ page }} / {{ totalPages }}
      </span>
      <button class="page-btn" [disabled]="page === totalPages" (click)="changePage(page + 1)">
        {{ 'products.pagination.next' | t }}
      </button>
    </div>
  </section>

  <ng-template #noProducts>
    <p class="empty-message">{{ 'products.empty' | t }}</p>
  </ng-template>
</div>
