<div class="product-detail-page" *ngIf="product; else loadingTpl">

  <div class="topbar">
    <button class="back-pill" type="button" (click)="goBack()">
      <span class="arrow">â†</span>
      <span class="txt">Retour aux produits</span>
    </button>
  </div>

  <p class="auth-warning" *ngIf="authWarning">{{ authWarning }}</p>

  <div class="product-detail-card">

    <div class="left">
      <div class="gallery">
        <button class="nav prev" type="button" (click)="prevImage()" [disabled]="!canSlide">â€¹</button>
        <button class="nav next" type="button" (click)="nextImage()" [disabled]="!canSlide">â€º</button>

        <div class="image-wrapper"
             [class.dragging]="isDragging"
             [class.animating]="isAnimating"
             (pointerdown)="onCarouselPointerDown($event)"
             (pointermove)="onCarouselPointerMove($event)"
             (pointerup)="onCarouselPointerUp($event)"
             (pointercancel)="onCarouselPointerCancel()"
             (click)="openZoom()">
          <div class="slide-track" [style.transform]="'translateX(' + dragOffsetX + 'px)'">
            <img class="main-img" [src]="activeImageUrl" [alt]="product.name" draggable="false" />
          </div>
        </div>

        <div class="thumbs" *ngIf="hasThumbs">
          <button type="button" class="thumb"
                  *ngFor="let img of images; let i = index"
                  [class.active]="i === activeImageIndex"
                  (click)="setActiveImage(i); $event.stopPropagation()">
            <img [src]="'http://localhost:8080' + img" [alt]="product.name" draggable="false" />
          </button>
        </div>
      </div>
    </div>

    <div class="right">
      <h1>{{ product.name }}</h1>

      <div class="price-block">
        <div class="price-row" *ngIf="hasPromo; else normalPriceTpl">
          <div class="sale-badge">-{{ discountPercent }}%</div>
          <div class="prices">
            <div class="old">{{ product.price | currency:'EUR' }}</div>
            <div class="new">{{ effectivePrice | currency:'EUR' }}</div>
          </div>
        </div>
        <ng-template #normalPriceTpl>
          <p class="price">{{ product.price | currency:'EUR' }}</p>
        </ng-template>

        <div class="promo-meta" *ngIf="promoStatus !== 'NONE'">
          <span class="promo-pill" [class.active]="promoStatus === 'ACTIVE'" [class.expired]="promoStatus === 'EXPIRED'">
            {{ promoStatusLabel }}
          </span>
        </div>
      </div>

      <div class="wishlist-row">
        <button type="button" class="wishlist-btn" [class.active]="isInWishlist" (click)="toggleWishlist()">
          {{ isInWishlist ? 'â¤ï¸ Retirer' : 'ğŸ¤ Wishlist' }}
        </button>
      </div>

      <div class="meta">
        <p *ngIf="product.description">{{ product.description }}</p>
      </div>

      <p class="stock-msg stock-warning" *ngIf="!isOutOfStock">Stock : {{ stockAvailable }}</p>
      <p class="stock-msg stock-error" *ngIf="isOutOfStock">Rupture de stock</p>

      <div class="qty-row">
        <button type="button" class="round-btn" (click)="decrease()" [disabled]="quantity === 0">âˆ’</button>
        <span class="qty-label">{{ quantity }}</span>
        <button type="button" class="round-btn" (click)="increase()" [disabled]="!canIncrease">+</button>
      </div>

      <button class="btn-cart-animated" type="button" (click)="addToCart()" [disabled]="isOutOfStock || !canIncrease">
        Ajouter au panier
      </button>
      <span class="added-msg" *ngIf="addedMessage">{{ addedMessage }}</span>
    </div>
  </div>

  <section class="reviews-section">
    <header class="reviews-header-block">
      <h3>Avis clients</h3>
      <div class="rating-overview">
        <div class="big-rating">{{ totalReviews > 0 ? (averageRating | number:'1.1-1') : '-' }} <span class="max">/5</span></div>
        <div class="stars-display">
          <span *ngFor="let s of [1,2,3,4,5]" class="star big" [class.filled]="s <= roundedAverage">â˜…</span>
        </div>
        <div class="total-count">BasÃ© sur {{ totalReviews }} avis</div>
      </div>
    </header>

    <div class="reviews-list-container">
      <p *ngIf="reviewsLoading" class="loading-text">Chargement des avis...</p>
      <div *ngIf="!reviewsLoading && reviews.length === 0" class="empty-state">Aucun avis pour le moment.</div>

      <ul class="review-list" *ngIf="!reviewsLoading && reviews.length > 0">
        <li *ngFor="let r of reviews" class="review-card">

          <div class="review-card-header">
            <div class="user-info">
              <div class="avatar">{{ r.authorName ? r.authorName.charAt(0).toUpperCase() : '?' }}</div>
              <div class="meta-user">
                <span class="username">{{ r.authorName }}</span>
                <span class="review-date">{{ r.createdAt | date:'dd MMM yyyy' }}</span>
              </div>
            </div>
            <div class="review-rating-stars">
              <span *ngFor="let s of [1,2,3,4,5]" class="star" [class.filled]="s <= r.rating">â˜…</span>
            </div>
          </div>

          <div *ngIf="r.status === 'DELETED'" class="alert-deleted">
            â›” Cet avis a Ã©tÃ© supprimÃ© par l'Ã©quipe de modÃ©ration (non-respect des conditions).
          </div>

          <div class="review-content" [class.content-muted]="r.status === 'DELETED'">
            <div *ngIf="editingReviewId !== r.id">
              <p class="comment-text">{{ r.comment }}</p>

              <div class="review-actions" *ngIf="r.mine && r.status !== 'DELETED'">
                <button type="button" class="text-btn" (click)="startEdit(r)">Modifier</button>
                <span class="separator">â€¢</span>
                <button type="button" class="text-btn danger" (click)="deleteReview(r)">Supprimer</button>
              </div>

              <div class="review-actions" *ngIf="r.mine && r.status === 'DELETED'">
                <button type="button" class="text-btn danger" (click)="deleteReview(r)">Supprimer dÃ©finitivement</button>
              </div>
            </div>

            <div *ngIf="editingReviewId === r.id" class="edit-box">
              <div class="form-row">
                <select [(ngModel)]="editRating" class="input-dark">
                  <option [value]="5">â˜…â˜…â˜…â˜…â˜…</option>
                  <option [value]="4">â˜…â˜…â˜…â˜…â˜†</option>
                  <option [value]="3">â˜…â˜…â˜…â˜†â˜†</option>
                  <option [value]="2">â˜…â˜…â˜†â˜†â˜†</option>
                  <option [value]="1">â˜…â˜†â˜†â˜†â˜†</option>
                </select>
              </div>
              <textarea rows="3" [(ngModel)]="editComment" class="input-dark"></textarea>
              <div class="edit-buttons">
                <button type="button" class="btn-cancel" (click)="cancelEdit()">Annuler</button>
                <button type="button" class="btn-save" (click)="submitEdit(r)">Enregistrer</button>
              </div>
            </div>
          </div>
        </li>
      </ul>
    </div>

    <div class="write-review-area">
      <div class="write-card">
        <h4>Donnez votre avis</h4>
        <p *ngIf="!isLoggedIn" class="login-prompt"><a routerLink="/login">Connectez-vous</a> pour donner votre avis.</p>

        <form *ngIf="isLoggedIn" (ngSubmit)="submitReview()" class="write-form">
          <label>Note</label>
          <select name="rating" [(ngModel)]="reviewRating" class="input-dark">
            <option [value]="5">â˜…â˜…â˜…â˜…â˜… Excellent</option>
            <option [value]="4">â˜…â˜…â˜…â˜…â˜† TrÃ¨s bon</option>
            <option [value]="3">â˜…â˜…â˜…â˜†â˜† Correct</option>
            <option [value]="2">â˜…â˜…â˜†â˜†â˜† Moyen</option>
            <option [value]="1">â˜…â˜†â˜†â˜†â˜† Mauvais</option>
          </select>

          <label>Commentaire</label>
          <textarea name="comment" rows="3" [(ngModel)]="reviewComment" class="input-dark" placeholder="Votre expÃ©rience..."></textarea>

          <div class="form-footer">
            <span *ngIf="reviewError" class="error-msg">{{ reviewError }}</span>
            <span *ngIf="reviewSuccessMsg" class="success-msg">{{ reviewSuccessMsg }}</span>
            <button type="submit" class="btn-submit" [disabled]="reviewSubmitting">Publier</button>
          </div>
        </form>
      </div>
    </div>
  </section>
</div>

<div class="zoom-backdrop" *ngIf="zoomOpen" (click)="closeZoom()" (wheel)="onZoomWheel($event)">
  <div class="zoom-panel" (click)="$event.stopPropagation()">
    <div class="zoom-topbar">
      <span>Zoom</span>
      <button class="zbtn danger" (click)="closeZoom()">âœ•</button>
    </div>
    <div class="zoom-body">
      <img [src]="activeImageUrl" class="zoom-img" [style.transform]="'scale(' + zoomScale + ')'">
    </div>
  </div>
</div>

<ng-template #loadingTpl><p class="center">Chargement...</p></ng-template>
