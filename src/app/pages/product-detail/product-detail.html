<div class="product-detail-page" *ngIf="product; else loadingOrError">
  <button class="btn-back" type="button" (click)="goBack()">
    â† Retour aux produits
  </button>

  <!-- âœ… Message visiteur -->
  <p class="auth-warning" *ngIf="authWarning">{{ authWarning }}</p>

  <!-- ========= CARTE PRODUIT (Haut de page) ========= -->
  <div class="product-detail-card">
    <div class="left">
      <div class="image-wrapper">
        <img
          [src]="product.imageUrls && product.imageUrls.length > 0
                    ? ('http://localhost:8080' + product.imageUrls[0])
                    : 'assets/img/products/placeholder-bag.jpg'"
          [alt]="product.name"
        />
      </div>
    </div>

    <div class="right">
      <h1>{{ product.name }}</h1>

      <p class="price">
        {{ product.price | currency: 'EUR' }}
      </p>

      <!-- Ligne wishlist / info rapide -->
      <div class="wishlist-row">
        <button
          type="button"
          class="wishlist-btn"
          [class.active]="isInWishlist"
          (click)="toggleWishlist()"
        >
          <span class="icon">
            {{ isInWishlist ? 'â¤ï¸' : 'ğŸ¤' }}
          </span>
          <span class="label">
            {{ isInWishlist ? 'Retirer de ma wishlist' : 'Ajouter Ã  ma wishlist' }}
          </span>
        </button>

        <span class="wishlist-hint" *ngIf="!isLoggedIn">
          (Vous devez Ãªtre connectÃ© pour utiliser la wishlist)
        </span>
      </div>

      <div class="meta">
        <p *ngIf="product.material">
          <strong>MatÃ©riau :</strong> {{ product.material }}
        </p>
        <p *ngIf="product.description">
          {{ product.description }}
        </p>

        <p class="stock-msg stock-warning" *ngIf="!isOutOfStock">
          Stock disponible : {{ stockAvailable }} piÃ¨ce(s).
        </p>
        <p class="stock-msg stock-error" *ngIf="isOutOfStock">
          Produit actuellement en rupture de stock.
        </p>
      </div>

      <div class="qty-row">
        <button
          type="button"
          class="round-btn"
          (click)="decrease()"
          [disabled]="quantity === 0"
        >
          âˆ’
        </button>
        <span class="qty-label">{{ quantity }}</span>
        <button
          type="button"
          class="round-btn"
          (click)="increase()"
          [disabled]="!canIncrease"
        >
          +
        </button>
      </div>

      <div class="actions">
        <button
          class="btn-cart-animated"
          type="button"
          (click)="addToCart()"
          [disabled]="isOutOfStock || !canIncrease"
        >
          ğŸ›’ Ajouter au panier
        </button>

        <span class="added-msg" *ngIf="addedMessage">
          {{ addedMessage }}
        </span>
      </div>

      <p class="stock-msg inline-msg" *ngIf="stockMessage">
        {{ stockMessage }}
      </p>
    </div>
  </div>

  <!-- ========= SECTION AVIS (VERTICALE) ========= -->
  <section class="reviews-section">

    <!-- 1. En-tÃªte des avis (Stats) -->
    <header class="reviews-header-block">
      <h3>Avis clients</h3>
      <div class="rating-overview">
        <div class="big-rating">
          {{ totalReviews > 0 ? (averageRating | number:'1.1-1') : '-' }}
          <span class="max">/5</span>
        </div>
        <div class="stars-display">
          <span *ngFor="let s of [1,2,3,4,5]" class="star big" [class.filled]="s <= roundedAverage">â˜…</span>
        </div>
        <div class="total-count">
          BasÃ© sur {{ totalReviews }} avis
        </div>
      </div>
    </header>

    <!-- 2. Liste des avis existants -->
    <div class="reviews-list-container">
      <p *ngIf="reviewsLoading" class="loading-text">Chargement des avis...</p>
      <p *ngIf="reviewsError" class="error-text">{{ reviewsError }}</p>

      <div *ngIf="!reviewsLoading && !reviewsError && reviews.length === 0" class="empty-state">
        Sois le premier Ã  donner votre avis sur ce produit !
      </div>

      <ul class="review-list" *ngIf="!reviewsLoading && !reviewsError && reviews.length > 0">
        <li *ngFor="let r of reviews" class="review-card">
          <div class="review-card-header">
            <div class="user-info">
              <div class="avatar">{{ r.authorName ? r.authorName.charAt(0).toUpperCase() : '?' }}</div>
              <div class="meta-user">
                <span class="username">{{ r.authorName }}</span>
                <span class="review-date">{{ r.createdAt | date:'dd MMM yyyy' }}</span>
              </div>
            </div>

            <div class="review-rating-stars">
              <span *ngFor="let s of [1,2,3,4,5]" class="star" [class.filled]="s <= r.rating">â˜…</span>
            </div>
          </div>

          <div class="review-content">
            <div *ngIf="editingReviewId !== r.id">
              <p class="comment-text">{{ r.comment }}</p>

              <div class="review-actions" *ngIf="r.mine">
                <button class="text-btn" (click)="startEdit(r)">Modifier</button>
                <span class="separator">â€¢</span>
                <button class="text-btn danger" (click)="deleteReview(r)">Supprimer</button>
              </div>
            </div>

            <div *ngIf="editingReviewId === r.id" class="edit-box">
              <div class="form-row">
                <label>Note :</label>
                <select [(ngModel)]="editRating" class="input-dark">
                  <option [value]="5">â˜…â˜…â˜…â˜…â˜… - Excellent</option>
                  <option [value]="4">â˜…â˜…â˜…â˜…â˜† - TrÃ¨s bon</option>
                  <option [value]="3">â˜…â˜…â˜…â˜†â˜† - Correct</option>
                  <option [value]="2">â˜…â˜…â˜†â˜†â˜† - Moyen</option>
                  <option [value]="1">â˜…â˜†â˜†â˜†â˜† - Mauvais</option>
                </select>
              </div>
              <div class="form-row">
                <textarea rows="3" [(ngModel)]="editComment" class="input-dark"></textarea>
              </div>
              <div class="edit-buttons">
                <button class="btn-cancel" (click)="cancelEdit()">Annuler</button>
                <button class="btn-save" (click)="submitEdit(r)" [disabled]="editSubmitting">Enregistrer</button>
              </div>
            </div>
          </div>
        </li>
      </ul>
    </div>

    <!-- 3. Formulaire d'ajout -->
    <div class="write-review-area">
      <div class="write-card">
        <h4>Donnez votre avis</h4>

        <p *ngIf="!isLoggedIn" class="login-prompt">
          <a routerLink="/login">Connectez-vous</a> pour partager votre expÃ©rience.
        </p>

        <form *ngIf="isLoggedIn" (ngSubmit)="submitReview()" class="write-form">
          <div class="rating-select-wrapper">
            <label>Votre note globale</label>
            <select name="rating" [(ngModel)]="reviewRating" class="input-dark large-select">
              <option [value]="5">â˜…â˜…â˜…â˜…â˜… (Excellent)</option>
              <option [value]="4">â˜…â˜…â˜…â˜…â˜† (TrÃ¨s bon)</option>
              <option [value]="3">â˜…â˜…â˜…â˜†â˜† (Correct)</option>
              <option [value]="2">â˜…â˜…â˜†â˜†â˜† (Moyen)</option>
              <option [value]="1">â˜…â˜†â˜†â˜†â˜† (Mauvais)</option>
            </select>
          </div>

          <div class="comment-input-wrapper">
            <label>Votre commentaire</label>
            <textarea
              name="comment"
              rows="4"
              placeholder="Qu'avez-vous pensÃ© de la qualitÃ©, du design..."
              [(ngModel)]="reviewComment"
              class="input-dark"
            ></textarea>
          </div>

          <div class="form-footer">
            <p *ngIf="reviewError" class="error-msg">{{ reviewError }}</p>
            <p *ngIf="reviewSuccessMsg" class="success-msg">{{ reviewSuccessMsg }}</p>

            <button type="submit" class="btn-submit" [disabled]="reviewSubmitting">
              {{ reviewSubmitting ? 'Envoi...' : 'Publier mon avis' }}
            </button>
          </div>
        </form>
      </div>
    </div>

  </section>
</div>

<ng-template #loadingOrError>
  <div class="product-detail-page center">
    <p *ngIf="loading">Chargement...</p>
    <p *ngIf="!loading && error">{{ error }}</p>
  </div>
</ng-template>
