<div class="product-detail-page" *ngIf="product; else loadingTpl">

  <!-- TOP BAR -->
  <div class="topbar">
    <button class="back-pill" type="button" (click)="goBack()">
      <span class="arrow">â†</span>
      <span class="txt">Retour aux produits</span>
    </button>
  </div>

  <p class="auth-warning" *ngIf="authWarning">{{ authWarning }}</p>

  <div class="product-detail-card">

    <!-- ===== GALERIE ===== -->
    <div class="left">
      <div class="gallery">

        <button class="nav prev" type="button" (click)="prevImage()" [disabled]="!canSlide" aria-label="Image prÃ©cÃ©dente">â€¹</button>
        <button class="nav next" type="button" (click)="nextImage()" [disabled]="!canSlide" aria-label="Image suivante">â€º</button>

        <div class="image-wrapper"
             [class.dragging]="isDragging"
             [class.animating]="isAnimating"
             (pointerdown)="onCarouselPointerDown($event)"
             (pointermove)="onCarouselPointerMove($event)"
             (pointerup)="onCarouselPointerUp($event)"
             (pointercancel)="onCarouselPointerCancel()"
             (click)="openZoom()">

          <div class="slide-track" [style.transform]="'translateX(' + dragOffsetX + 'px)'">
            <img class="main-img" [src]="activeImageUrl" [alt]="product.name" draggable="false" />
          </div>
        </div>

        <div class="thumbs" *ngIf="hasThumbs">
          <button type="button" class="thumb"
                  *ngFor="let img of images; let i = index"
                  [class.active]="i === activeImageIndex"
                  (click)="setActiveImage(i); $event.stopPropagation()">
            <img [src]="'http://localhost:8080' + img" [alt]="product.name + ' ' + (i + 1)" draggable="false" />
          </button>
        </div>

        <p class="swipe-hint" *ngIf="canSlide">Swipe / drag â€¢ â† â†’ â€¢ Clique pour zoom</p>
      </div>
    </div>

    <!-- ===== INFOS ===== -->
    <div class="right">
      <h1>{{ product.name }}</h1>

      <!-- âœ… PRIX + PROMO -->
      <div class="price-block">

        <div class="price-row" *ngIf="hasPromo; else normalPriceTpl">
          <div class="sale-badge">
            -{{ discountPercent }}%
          </div>

          <div class="prices">
            <div class="old">
              {{ product.price | currency:'EUR' }}
            </div>
            <div class="new">
              {{ effectivePrice | currency:'EUR' }}
            </div>
          </div>
        </div>

        <ng-template #normalPriceTpl>
          <p class="price">{{ product.price | currency:'EUR' }}</p>
        </ng-template>

        <!-- âœ… ETAT PROMO + DATES -->
        <div class="promo-meta" *ngIf="promoStatus !== 'NONE'">
          <span class="promo-pill"
                [class.active]="promoStatus === 'ACTIVE'"
                [class.upcoming]="promoStatus === 'UPCOMING'"
                [class.expired]="promoStatus === 'EXPIRED'">
            {{ promoStatusLabel }}
          </span>

          <div class="promo-dates" *ngIf="product.promoStartAt || product.promoEndAt">
            <span *ngIf="product.promoStartAt">
              DÃ©but : {{ product.promoStartAt | date:'dd/MM/yyyy HH:mm' }}
            </span>
            <span *ngIf="product.promoEndAt">
              Fin : {{ product.promoEndAt | date:'dd/MM/yyyy HH:mm' }}
            </span>
          </div>
        </div>

      </div>

      <div class="wishlist-row">
        <button type="button" class="wishlist-btn" [class.active]="isInWishlist" (click)="toggleWishlist()">
          {{ isInWishlist ? 'â¤ï¸ Retirer' : 'ğŸ¤ Wishlist' }}
        </button>
      </div>

      <div class="meta">
        <p *ngIf="product.description">{{ product.description }}</p>
      </div>

      <p class="stock-msg stock-warning" *ngIf="!isOutOfStock">
        Stock disponible : {{ stockAvailable }} piÃ¨ce(s).
      </p>

      <p class="stock-msg stock-error" *ngIf="isOutOfStock">
        Produit actuellement en rupture de stock.
      </p>

      <div class="qty-row">
        <button type="button" class="round-btn" (click)="decrease()" [disabled]="quantity === 0">âˆ’</button>
        <span class="qty-label">{{ quantity }}</span>
        <button type="button" class="round-btn" (click)="increase()" [disabled]="!canIncrease">+</button>
      </div>

      <p class="stock-msg inline-msg" *ngIf="stockMessage">{{ stockMessage }}</p>

      <button class="btn-cart-animated" type="button" (click)="addToCart()" [disabled]="isOutOfStock || !canIncrease">
        Ajouter au panier
      </button>

      <span class="added-msg" *ngIf="addedMessage">{{ addedMessage }}</span>
    </div>
  </div>

  <!-- ========= SECTION AVIS (VERTICALE) ========= -->
  <section class="reviews-section">

    <header class="reviews-header-block">
      <h3>Avis clients</h3>
      <div class="rating-overview">
        <div class="big-rating">
          {{ totalReviews > 0 ? (averageRating | number:'1.1-1') : '-' }}
          <span class="max">/5</span>
        </div>
        <div class="stars-display">
          <span *ngFor="let s of [1,2,3,4,5]" class="star big" [class.filled]="s <= roundedAverage">â˜…</span>
        </div>
        <div class="total-count">BasÃ© sur {{ totalReviews }} avis</div>
      </div>
    </header>

    <div class="reviews-list-container">
      <p *ngIf="reviewsLoading" class="loading-text">Chargement des avis...</p>
      <p *ngIf="reviewsError" class="error-text">{{ reviewsError }}</p>

      <div *ngIf="!reviewsLoading && !reviewsError && reviews.length === 0" class="empty-state">
        Sois le premier Ã  donner votre avis sur ce produit !
      </div>

      <ul class="review-list" *ngIf="!reviewsLoading && !reviewsError && reviews.length > 0">
        <li *ngFor="let r of reviews" class="review-card">
          <div class="review-card-header">
            <div class="user-info">
              <div class="avatar">{{ r.authorName ? r.authorName.charAt(0).toUpperCase() : '?' }}</div>
              <div class="meta-user">
                <span class="username">{{ r.authorName }}</span>
                <span class="review-date">{{ r.createdAt | date:'dd MMM yyyy' }}</span>
              </div>
            </div>

            <div class="review-rating-stars">
              <span *ngFor="let s of [1,2,3,4,5]" class="star" [class.filled]="s <= r.rating">â˜…</span>
            </div>
          </div>

          <div class="review-content">
            <div *ngIf="editingReviewId !== r.id">
              <p class="comment-text">{{ r.comment }}</p>

              <div class="review-actions" *ngIf="r.mine">
                <button type="button" class="text-btn" (click)="startEdit(r)">Modifier</button>
                <span class="separator">â€¢</span>
                <button type="button" class="text-btn danger" (click)="deleteReview(r)">Supprimer</button>
              </div>
            </div>

            <div *ngIf="editingReviewId === r.id" class="edit-box">
              <div class="form-row">
                <label>Note :</label>
                <select [(ngModel)]="editRating" class="input-dark">
                  <option [value]="5">â˜…â˜…â˜…â˜…â˜… - Excellent</option>
                  <option [value]="4">â˜…â˜…â˜…â˜…â˜† - TrÃ¨s bon</option>
                  <option [value]="3">â˜…â˜…â˜…â˜†â˜† - Correct</option>
                  <option [value]="2">â˜…â˜…â˜†â˜†â˜† - Moyen</option>
                  <option [value]="1">â˜…â˜†â˜†â˜†â˜† - Mauvais</option>
                </select>
              </div>

              <div class="form-row">
                <textarea rows="3" [(ngModel)]="editComment" class="input-dark"></textarea>
              </div>

              <div class="edit-buttons">
                <button type="button" class="btn-cancel" (click)="cancelEdit()">Annuler</button>
                <button type="button" class="btn-save" (click)="submitEdit(r)" [disabled]="editSubmitting">
                  Enregistrer
                </button>
              </div>
            </div>

          </div>
        </li>
      </ul>
    </div>

    <div class="write-review-area">
      <div class="write-card">
        <h4>Donnez votre avis</h4>

        <p *ngIf="!isLoggedIn" class="login-prompt">
          <a routerLink="/login">Connectez-vous</a> pour partager votre expÃ©rience.
        </p>

        <form *ngIf="isLoggedIn" (ngSubmit)="submitReview()" class="write-form">
          <div class="rating-select-wrapper">
            <label>Votre note globale</label>
            <select name="rating" [(ngModel)]="reviewRating" class="input-dark large-select">
              <option [value]="5">â˜…â˜…â˜…â˜…â˜… (Excellent)</option>
              <option [value]="4">â˜…â˜…â˜…â˜…â˜† (TrÃ¨s bon)</option>
              <option [value]="3">â˜…â˜…â˜…â˜†â˜† (Correct)</option>
              <option [value]="2">â˜…â˜…â˜†â˜†â˜† (Moyen)</option>
              <option [value]="1">â˜…â˜†â˜†â˜†â˜† (Mauvais)</option>
            </select>
          </div>

          <div class="comment-input-wrapper">
            <label>Votre commentaire</label>
            <textarea
              name="comment"
              rows="4"
              placeholder="Qu'avez-vous pensÃ© de la qualitÃ©, du design..."
              [(ngModel)]="reviewComment"
              class="input-dark"></textarea>
          </div>

          <div class="form-footer">
            <p *ngIf="reviewError" class="error-msg">{{ reviewError }}</p>
            <p *ngIf="reviewSuccessMsg" class="success-msg">{{ reviewSuccessMsg }}</p>

            <button type="submit" class="btn-submit" [disabled]="reviewSubmitting">
              {{ reviewSubmitting ? 'Envoi...' : 'Publier mon avis' }}
            </button>
          </div>
        </form>
      </div>
    </div>

  </section>
</div>

  <!-- âœ… ZOOM MODAL -->
  <div class="zoom-backdrop" *ngIf="zoomOpen" (click)="onZoomBackdropClick($event)" (wheel)="onZoomWheel($event)">
    <div class="zoom-panel" (click)="$event.stopPropagation()">
      <div class="zoom-topbar">
        <div class="zoom-title">Zoom image</div>

        <div class="zoom-actions">
          <button type="button" class="zbtn" (click)="zoomOut()" [disabled]="zoomScale <= zoomMin">âˆ’</button>
          <button type="button" class="zbtn" (click)="resetZoom()">1:1</button>
          <button type="button" class="zbtn" (click)="zoomIn()" [disabled]="zoomScale >= zoomMax">+</button>
          <button type="button" class="zbtn danger" (click)="closeZoom()">âœ•</button>
        </div>
      </div>

      <div class="zoom-body">
        <img class="zoom-img"
             [src]="activeImageUrl"
             [style.transform]="'scale(' + zoomScale + ')'"
             draggable="false"
             alt="Zoom" />
      </div>

      <div class="zoom-hint">
        Molette pour zoom â€¢ ESC pour fermer â€¢ â† â†’ pour changer
      </div>
    </div>
  </div>

<ng-template #loadingTpl>
  <div class="product-detail-page center">
    <p *ngIf="loading">Chargementâ€¦</p>
    <p *ngIf="!loading && error">{{ error }}</p>
  </div>
</ng-template>
