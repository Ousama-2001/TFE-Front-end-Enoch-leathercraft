<div class="my-orders-page">
  <h1>{{ 'orders.title' | t }}</h1>
  <p class="subtitle">{{ 'orders.subtitle' | t }}</p>

  <p class="alert info" *ngIf="infoMessage">{{ infoMessage }}</p>
  <p class="alert error" *ngIf="errorMessage">{{ errorMessage }}</p>

  <p class="info" *ngIf="loading">{{ 'orders.loading' | t }}</p>
  <p class="error" *ngIf="error">{{ error }}</p>

  <div *ngIf="!loading && !error && orders.length === 0" class="empty">
    {{ 'orders.empty' | t }}
  </div>

  <div class="orders-list" *ngIf="!loading && !error && orders.length > 0">
    <article class="order-card" *ngFor="let o of orders">

      <div class="order-main">
        <div>
          <h2>{{ 'orders.card.titlePrefix' | t }} {{ o.reference }}</h2>
          <p class="date">
            {{ 'orders.datePrefix' | t }}
            {{ o.createdAt | date:'dd/MM/yyyy à HH:mm' }}
          </p>
        </div>

        <div class="order-meta">
          <span [class]="getStatusClass(o.status)">
            {{ getStatusLabel(o.status) }}
          </span>
          <div class="amount">
            {{ o.totalAmount | currency:'EUR' }}
          </div>
        </div>
      </div>

      <div class="order-summary">
        {{ o.items.length }} {{ 'orders.itemsSuffix' | t }}
      </div>

      <div class="pending-warning" *ngIf="o.status === 'PENDING'">
        ⚠️ <strong>Attention :</strong> Vous avez jusqu'au
        <b>{{ getExpirationDate(o.createdAt) | date:'dd/MM/yyyy à HH:mm' }}</b>
        pour régler cette commande. Passé ce délai, elle sera automatiquement annulée.
      </div>

      <div class="return-info" *ngIf="o.status === 'RETURN_REQUESTED'">
        {{ 'returns.info.requested' | t }}
      </div>

      <div class="return-info success" *ngIf="o.status === 'RETURN_APPROVED'">
        {{ 'returns.info.approved' | t }}
      </div>

      <div class="return-info danger" *ngIf="o.status === 'RETURN_REJECTED'">
        {{ 'returns.info.rejected' | t }}
        <ng-container *ngIf="o.notes">
          <br />
          <strong>{{ 'returns.reason.label' | t }}</strong>
          <pre class="reason-text">{{ o.notes }}</pre>
        </ng-container>
      </div>

      <div class="order-actions">
        <a [routerLink]="['/my-orders', o.id]" class="btn ghost">
          {{ 'orders.detailLink' | t }}
        </a>

        <button type="button" class="btn secondary"
                *ngIf="canCancel(o)"
                (click)="cancelOrder(o)"
                [disabled]="actionLoading[o.id]">
          {{ 'orders.actions.cancel' | t }}
        </button>

        <button type="button" class="btn primary"
                *ngIf="canPay(o)"
                (click)="payOrder(o)"
                [disabled]="actionLoading[o.id]">
          {{ actionLoading[o.id] ? ('orders.actions.processing' | t) : ('orders.actions.payNow' | t) }}
        </button>

        <button type="button" class="btn secondary"
                *ngIf="canRequestReturn(o) && !showReturnForm[o.id]"
                (click)="openReturnForm(o)"
                [disabled]="actionLoading[o.id]">
          {{ 'returns.actions.request' | t }}
        </button>

        <button type="button" class="btn ghost"
                *ngIf="canDownloadInvoice(o)"
                (click)="downloadInvoice(o)"
                [disabled]="actionLoading[o.id]">
          {{ 'orders.actions.invoice' | t }}
        </button>

        <button type="button" class="btn secondary"
                *ngIf="hasReturnLabel(o)"
                (click)="downloadReturnLabel(o)"
                [disabled]="actionLoading[o.id]">
          {{ 'returns.actions.label' | t }}
        </button>
      </div>

      <div class="return-form" *ngIf="showReturnForm[o.id]">
        <h3>{{ 'returns.form.title' | t }}</h3>

        <label>
          {{ 'returns.form.selectLabel' | t }}
          <select [(ngModel)]="selectedReasonKey[o.id]">
            <option *ngFor="let k of returnReasonKeys" [ngValue]="k">
              {{ k | t }}
            </option>
          </select>
        </label>

        <label>
          {{ 'returns.form.commentLabel' | t }}
          <textarea
            rows="3"
            [(ngModel)]="returnComment[o.id]"
            [placeholder]="'returns.form.placeholder' | t">
          </textarea>
        </label>

        <div class="return-actions">
          <button type="button" class="btn primary"
                  (click)="submitReturn(o)"
                  [disabled]="actionLoading[o.id]">
            {{ 'returns.form.confirm' | t }}
          </button>

          <button type="button" class="btn ghost"
                  (click)="cancelReturnForm(o)"
                  [disabled]="actionLoading[o.id]">
            {{ 'common.cancel' | t }}
          </button>
        </div>
      </div>

    </article>
  </div>
</div>
